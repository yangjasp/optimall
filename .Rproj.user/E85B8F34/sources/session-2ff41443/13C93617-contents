---
title: "BIOST 515/518 Homework 7"
author: "Jasper Yang"
date: "3/4/2024"
output:
  pdf_document
---


```{r setup, include=FALSE}
### Setting up the packages, options we'll need:
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
labs = knitr::all_labels()
labs = labs[!labs %in% c("setup", "llm_appendix", "allcode")]
```

```{r, include=F}
### -----------------------------------------------------------
### Reading in the data. 
library(dplyr)
library(flextable)
library(rigr)
library(ggplot2)
library(ggsci)
library(cowplot)
library(rigr)
library(survival)
library(survminer)
thiotepa <- read.csv("/Users/jasper/Library/Mobile Documents/com~apple~CloudDocs/Desktop/UW Biostatistics 2023-24/BIOST515/HW7/thiotepa.csv")
```

# Responses 

#### 1. Construct Kaplan-Meier curves for the placebo and thiotepa arms. Describe and compare the curves.


```{r Q1, echo=F, fig.width=5, fig.height=5, fig.cap="Figure 1"}
### -----------------------------------------------------------
### Q1
thiotepa$Treatment <- ifelse(thiotepa$rx == 1, "Placebo", "Thiotepa")
tte <- thiotepa %>% with(Surv(stop, event))
survfit(tte ~ Treatment, thiotepa) %>%
  ggsurvplot(data = thiotepa, conf.int = TRUE, xlab = "Time (months)",
             ylab = "Estimated \n survival function")
```

Based on the plot, the estimated survival function for patients that received Thiotepa treatment is greater than the estimated survival function for patients who received a placebo at most times after about 8 months. Until 8 months, the two survival curves are very similar. The confidence intervals, which reflect the uncertainty of the estimated survival at the different time points are somewhat wide. 

#### 2. Use a log-rank test to compare the distribution of time to relapse in the two treatment arms. In language suitable for a scientific publication, summarize your findings.

```{r Q2, include = FALSE}
### -----------------------------------------------------------
### Q2
survdiff(Surv(stop, event) ~ Treatment, data = thiotepa)
```

Based on a log-rank test, we do not have strong evidence to conclude that there is a difference in time to tumor relapse (survival) between two populations of bladder cancer patients in 1970, one that was given thiopeta and another that was given a placebo treatment (p = 0.2).

#### 3) Fit a Cox proportional hazards model with treatment arm as the predictor. Write out the fitted model, and interpret the parameters of your model (including the baseline hazard).

```{r Q3, include = FALSE}
### -----------------------------------------------------------
### Q3
model3 <- coxph(tte ~ Treatment, data = thiotepa)
model3
```

The Cox proportional hazard model models

\begin{align*}
\widehat{\log\left(\frac{h_i(t)}{h_0(t)}\right)} =  \beta_1 \cdot (\mathbb{I}[\text{Thiotepa}]),
\end{align*}

where

* $\beta_1$ is the estimated difference in log-hazard for relapse between two populations of bladder cancer patients in 1970, one who received thiopeta and another who received a placebo treatment. Note that $\exp(\beta_1)$ is the hazard ratio (multiplicative difference of hazard) between these two groups.
* Baseline hazard: The baseline hazard, $H_0(t)$, is the hazard function for a population of bladder cancer patients in 1970 who recevied placebo treatment. It is not estimated by the model.

The fitted model from the Cox proportional hazards model is

\begin{align*}
\widehat{\log\left(\frac{h_i(t)}{h_0(t)}\right)} =  -0.3706 \cdot (\mathbb{I}[\text{Thiotepa}]),
\end{align*}

The parameters are

* Thiotepa: Based on a Cox proportional hazards model, The estimated difference in log-hazard for relapse between two populations of bladder cancer patients in 1970, one who received thiopeta and another who received a placebo treatment, is -0.3706, with the population receiving thiotepa having a lower log-hazard.
* Baseline hazard: The baseline hazard, $H_0(t)$, is the hazard function for a population of bladder cancer patients in 1970 who recevied placebo treatment. It is not estimated by the model.

#### 4) Using the Cox model that you fit in (3), perform full inference on the hazard ratio for relapse, summarizing your findings in language suitable for scientific publication.

Based on this Cox proportional hazards model, we estimate that when comparing two populations of bladder cancer patients in 1970, one who received thiotepa and another who received a placebo treatment, the hazard ratio for relapse is 0.6903 (95% CI  0.381 - 1.249, likelihood ratio test p = 0.215), with the population receiving a placebo having a greater hazard for relapse. At the 0.05 level, we do not have evidence to reject the null hypothesis that the hazard for relapse in one population of bladder cancer patients who receive placebo and another who receive thiotepa is equal. 

```{r, Q4, include = FALSE}
### -----------------------------------------------------------
### Q4
exp(confint(model3))
```

#### 5) Are null hypotheses that you tested in (2) and (4) the same? Justify your response.

Yes, the null hypotheses I test when conducting the log-rank test and performing inference on the Cox proportional hazard coefficient are the same. Although the tests themselves are different because they have different assumptions (namely, the proportional hazard test assumes proprtional hazards while the log-rank test does not assume this), the null hypotheses that they are testing are the same! The null hypothesis for the log-rank test is $H_0:$ The survival function for the placebo and thiotepa groups are the same at all times $t$. The null hypothesis for the Cox coefficient is that $\beta_1 = 0$, i.e. $H_1(t) = H_0(t)$ (at all time $t$), which implies that the survival function for the placebo and thiotepa groups are the same at all times $t$. Thus, these null hypotheses are the same thing!

One analogy I used to think about this problem is that even though a robust Wald and non-robust Wald test are different tests and have different assumptions, they have the same null hypothesis!

#### 6) Now fit a Cox proportional hazards model with treatment arm and size of largest initial tumor as predictors. Write out the fitted model, and interpret the parameters of your model

```{r Q6, include = FALSE}
### -----------------------------------------------------------
### Q6
model6 <- coxph(tte ~ Treatment + size, data = thiotepa)
model6
```

The Cox proportional hazard model here models

\begin{align*}
\widehat{\log\left(\frac{h_i(t)}{h_0(t)}\right)} =  \beta_1 \cdot (\mathbb{I}[\text{Thiotepa}]) + \beta_2 \cdot \text{Largest initial tumor size},
\end{align*}

* $\beta_1$ is the estimated difference in log-hazard for relapse between two populations of bladder cancer patients in 1970 with the same largest initial tumor size, but who differ in that one received thiopeta and another received a placebo treatment. Note that $\exp(\beta_1)$ is the hazard ratio (multiplicative difference of hazard) between these two groups.
* $\beta_2$ is the estimated difference in log-hazard for relapse between two populations of bladder cancer patients in 1970 who received the same treatment, but one had a largest initial tumor size 1 cm larger than the other. Note that $\exp(\beta_2)$ is the hazard ratio (multiplicative difference of hazard) between these two groups.
* Baseline hazard: The baseline hazard, $H_0(t)$, is the hazard function for a population of bladder cancer patients in 1970 who recevied placebo treatment. It is not estimated by the model.

The fitted model from the Cox proportional hazards model is

\begin{align*}
\widehat{\log\left(\frac{h_i(t)}{h_0(t)}\right)} =  -0.3677 \cdot (\mathbb{I}[\text{Thiotepa}]) + 0.0266 \cdot \text{Largest initial tumor size},
\end{align*}

where tumor size is in centimeters. The parameters are

* Thiotepa: Based on a Cox proportional hazards model, The estimated difference in log-hazard for relapse between two populations of bladder cancer patients in 1970 who have the same largest initial tumor size, but one received thiopeta and another received a placebo treatment is -0.3677, with the population receiving thiotepa having a lower log-hazard.
* Tumor size: Based on a Cox proportional hazards model, The estimated difference in log-hazard for relapse between two populations of bladder cancer patients in 1970 who received the same treatment, but one had a largest initial tumor size 1 cm greater is 0.0266, with the population with a larger initial tumor size having a higher log-hazard.
* Baseline hazard: The baseline hazard, $H_0(t)$, is the hazard function for a population of bladder cancer patients in 1970 who received placebo treatment and had a tumor size of 0. It is not estimated by the model.

#### 7) A colleague asks if size of the largest tumor (pre-treatment) is a potential confounder for time to relapse. What do you think and why? 

No, I do not think that the largest tumor size pre-treatment is a potential confounder. Patients were randomly assigned to a treatment group, so initial tumor size willl not be associated with treatment.

## Code Appendix

```{r allcode, ref.label = knitr::all_labels(), echo=TRUE, eval=FALSE}
```

\pagebreak

## LLM Appendix

I did not use any LLMs for this homework.
