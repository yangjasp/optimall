<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="optimall">
<title>Using Optimall • optimall</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using Optimall">
<meta property="og:description" content="optimall">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">optimall</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Multiwave-Estimation.html">Estimation in Two-phase, Multi-wave sampling</a>
    <a class="dropdown-item" href="../articles/Multiwave-Object.html">Multiwave Object</a>
    <a class="dropdown-item" href="../articles/optimall-vignette.html">Using Optimall</a>
    <a class="dropdown-item" href="../articles/using-optimall_shiny.html">Splitting Strata with Optimall Shiny</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/yangjasp/optimall/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using Optimall</h1>
                        <h4 data-toc-skip class="author">Jasper Yang and
Pamela Shaw</h4>
            
            <h4 data-toc-skip class="date">Last updated: June 06,
2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/yangjasp/optimall/blob/HEAD/vignettes/optimall-vignette.Rmd" class="external-link"><code>vignettes/optimall-vignette.Rmd</code></a></small>
      <div class="d-none name"><code>optimall-vignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>When a study population is composed of heterogeneous subpopulations,
stratified random sampling techniques are often employed to obtain more
precise estimates of population characteristics. Efficiently allocating
samples to strata under this method is a crucial step in the study
design, especially when sampling is expensive.</p>
<p><code>optimall</code> offers a collection of functions that are
designed to streamline the process of optimum sample allocation, for a
single wave or an adaptive, multi-wave approach. Its main functions
allow users to:</p>
<ul>
<li><p>Define, split, and merge strata based on values or percentiles of
other variables.</p></li>
<li><p>Calculate the optimum number of samples to allocate to each
stratum in a given study in order to minimize the variance of the target
sample mean.</p></li>
<li><p>Select specific IDs to sample based on a stratified sampling
design.</p></li>
<li><p>Optimally allocate a fixed number of samples to a sampling wave
based on results from a prior wave.</p></li>
</ul>
<p>When used together, these functions can automate most of the sampling
workflow. This vignette will outline these package features one by one
(moving from simple to more complex), introduce the theoretical
framework behind the functions, and finally demonstrate how they can be
used collectively to perform multi-wave sampling in R. The final section
then details how to use <code><a href="../reference/optimall_shiny.html">optimall_shiny()</a></code> to efficiently
make decisions about splitting strata.</p>
</div>
<div class="section level2">
<h2 id="defining-and-refining-strata">Defining and Refining Strata<a class="anchor" aria-label="anchor" href="#defining-and-refining-strata"></a>
</h2>
<p>In stratified sampling, strata are typically defined on values or
quantiles of inexpensive variables available for the entire population.
Given a dataset with one row per sampling unit and at least one column
containing a variable that can be used to construct strata,
<code>optimall</code> allows users to easily define, split, and merge
strata.</p>
<p>To demonstrate the simple process of refining strata in
<code>optimall</code>, we use the <code>iris</code> dataset from the R
package <code>datasets</code>. Suppose that we have defined three strata
based on <code>"Species"</code>, but we want to split two out of the
three, setosa and virginica, in half based on the within-stratum median
of <code>"Sepal.Width"</code>. In <code>optimall</code>, we can do this
by calling the <code><a href="../reference/split_strata.html">split_strata()</a></code> function:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yangjasp/optimall" class="external-link">optimall</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">datasets</span><span class="op">)</span></span>
<span></span>
<span><span class="va">iris</span> <span class="op">&lt;-</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html" class="external-link">iris</a></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     setosa versicolor  virginica </span></span>
<span><span class="co">#&gt;         50         50         50</span></span>
<span><span class="va">iris2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/split_strata.html">split_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris</span>,</span>
<span>                     strata <span class="op">=</span> <span class="st">"Species"</span>,</span>
<span>                     split <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"setosa"</span>, <span class="st">"virginica"</span><span class="op">)</span>, </span>
<span>                     split_var <span class="op">=</span> <span class="st">"Sepal.Width"</span>,</span>
<span>                     split_at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"local quantile"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">iris2</span><span class="op">$</span><span class="va">new_strata</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  setosa.Sepal.Width_(3.4,4.4]  setosa.Sepal.Width_[2.3,3.4] </span></span>
<span><span class="co">#&gt;                            22                            28 </span></span>
<span><span class="co">#&gt;                    versicolor virginica.Sepal.Width_(3,3.8] </span></span>
<span><span class="co">#&gt;                            50                            17 </span></span>
<span><span class="co">#&gt; virginica.Sepal.Width_[2.2,3] </span></span>
<span><span class="co">#&gt;                            33</span></span></code></pre></div>
<p>Similarly, we can merge strata using the function
<code><a href="../reference/merge_strata.html">merge_strata()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_strata.html">merge_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris</span>,</span>
<span>                     strata <span class="op">=</span> <span class="st">"Species"</span>,</span>
<span>                     merge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"setosa"</span>, <span class="st">"versicolor"</span><span class="op">)</span>, </span>
<span>                     name <span class="op">=</span> <span class="st">"set_or_vers"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">iris3</span><span class="op">$</span><span class="va">new_strata</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; set_or_vers   virginica </span></span>
<span><span class="co">#&gt;         100          50</span></span></code></pre></div>
<p>The <code>split_strata</code> and <code><a href="../reference/merge_strata.html">merge_strata()</a></code>
functions are quite versatile. See function documentation for more
information.</p>
</div>
<div class="section level2">
<h2 id="optimum-allocation">Optimum Allocation<a class="anchor" aria-label="anchor" href="#optimum-allocation"></a>
</h2>
<p>Assuming that the per-unit sampling cost is the same in each stratum
and that <span class="math inline">\(S_h\)</span>, the standard
deviation of the variable of interest within each stratum, can be
estimated, Neyman (1934) presented the following solution to optimally
allocate <span class="math inline">\(n\)</span> samples among <span class="math inline">\(H\)</span> strata in order to minimize the
variance of the sample mean:</p>
<p><span class="math display">\[n_h = n \frac{N_hS_h}{\sum_{i=1}^H
N_iS_i}.\]</span> This formula is known as Neyman allocation and is one
of the functions available in <code>optimall</code>. Neyman allocation
offers the advantage of outputting sampling fractions that can later be
multiplied by <span class="math inline">\(n\)</span> or taken on their
own if <span class="math inline">\(n\)</span> is not known.</p>
<p>While Neyman allocation has a strong theoretical backing, Wright
(2014) points out some limitations that make it sub-optimal in
practice.</p>
<ol style="list-style-type: decimal">
<li>Neyman does not require that the solution to <span class="math inline">\(n_h\)</span> is an integer, and thus it rarely is.
When taking a fraction of a sample is not practical, researchers are
forced to stray from the theory by rounding the sample sizes in ways
that are not always optimal.</li>
<li>Closely related to the first issue, the rounded results for <span class="math inline">\(n_h\)</span> are not guaranteed to sum to <span class="math inline">\(n\)</span>. This is clearly sub-optimal.</li>
</ol>
<p>Wright offers alternative algorithms that solve the optimal problem
for a discrete allocation that sums exactly to <span class="math inline">\(n\)</span>, which can also be implemented in
<code>optimall</code>. Essentially, his approaches use linear
constraints to optimize the allocation of samples over a space of
integer values. He makes use of within-stratum variance and population
stratum size to generate priority values, which in turn dictate how many
samples should be taken from each stratum. To learn more about the
specifics of these algorithms, see Wright (2014).</p>
<p>The <code>optimall</code> package allows users to select between
Neyman allocation, Wright Algorithm I, and Wright Algorithm II in the
<code>method</code> argument of the <code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code>
function. The <code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code> function defaults to
using Wright Algorithm II. This algorithm requires that at least 2
samples are taken from each stratum. In <code>optimall</code>, stratum
sampling sizes for both Wright algorithms are also constrained from
above at <span class="math inline">\(N_h\)</span>, the population
stratum size, using the methods for constraints that Wright details in
Algorithm III.</p>
<p>Below is an example of how <code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code> could be
called to optimally allocate 40 samples among <code>"Species"</code> in
the <code>iris</code> dataset, minimizing the variance of the
<code>"Sepal.Width"</code> sample mean.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sampling_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimum_allocation.html">optimum_allocation</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris</span>, strata <span class="op">=</span> <span class="st">"Species"</span>, </span>
<span>                                      y <span class="op">=</span> <span class="st">"Sepal.Width"</span>,</span>
<span>                                      nsample <span class="op">=</span> <span class="fl">40</span>, method <span class="op">=</span> <span class="st">"WrightII"</span><span class="op">)</span></span>
<span><span class="va">sampling_design</span></span>
<span><span class="co">#&gt;       strata npop   sd  n_sd stratum_fraction stratum_size</span></span>
<span><span class="co">#&gt; 1     setosa   50 0.38 18.95             0.38           15</span></span>
<span><span class="co">#&gt; 2 versicolor   50 0.31 15.69             0.30           12</span></span>
<span><span class="co">#&gt; 3  virginica   50 0.32 16.12             0.32           13</span></span></code></pre></div>
<p>If we have a dataframe that holds the <span class="math inline">\(N_h\)</span> and <span class="math inline">\(sd_h\)</span> for each stratum instead of data for
each individual unit, we can still use
<code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span>,</span>
<span>                           size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>                           sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3791</span>, <span class="fl">0.3138</span>, <span class="fl">0.3225</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/optimum_allocation.html">optimum_allocation</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris_summary</span>, strata <span class="op">=</span> <span class="st">"strata"</span>,</span>
<span>                   sd_h <span class="op">=</span> <span class="st">"sd"</span>, N_h <span class="op">=</span> <span class="st">"size"</span>, </span>
<span>                   nsample <span class="op">=</span> <span class="fl">40</span>, method <span class="op">=</span> <span class="st">"WrightII"</span><span class="op">)</span></span>
<span><span class="co">#&gt;       strata npop   sd  n_sd stratum_fraction stratum_size</span></span>
<span><span class="co">#&gt; 1     setosa   50 0.38 18.95             0.38           15</span></span>
<span><span class="co">#&gt; 2 versicolor   50 0.31 15.69             0.30           12</span></span>
<span><span class="co">#&gt; 3  virginica   50 0.32 16.12             0.32           13</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="selecting-ids-to-sample">Selecting IDs to Sample<a class="anchor" aria-label="anchor" href="#selecting-ids-to-sample"></a>
</h2>
<p>With the number of units to sample per stratum specified in a
dataframe, <code>optimall</code> can select the IDs of the units to be
sampled using simple random sampling within strata with the function
<code><a href="../reference/sample_strata.html">sample_strata()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">150</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">743</span><span class="op">)</span></span>
<span></span>
<span><span class="va">iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_strata.html">sample_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris</span>, strata <span class="op">=</span> <span class="st">"Species"</span>, id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>                               design_data <span class="op">=</span> <span class="va">sampling_design</span>, design_strata <span class="op">=</span> <span class="st">"strata"</span>,</span>
<span>                               n_allocated <span class="op">=</span> <span class="st">"stratum_size"</span><span class="op">)</span></span></code></pre></div>
<p>The output of <code><a href="../reference/sample_strata.html">sample_strata()</a></code> is the same input
dataframe with a new column called <code>"sample_indicator"</code> that
holds a binary indicator for whether each unit should be sampled in the
specified wave:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species id sample_indicator</span></span>
<span><span class="co">#&gt; 1          5.1         3.5          1.4         0.2  setosa  1                0</span></span>
<span><span class="co">#&gt; 2          4.9         3.0          1.4         0.2  setosa  2                0</span></span>
<span><span class="co">#&gt; 3          4.7         3.2          1.3         0.2  setosa  3                0</span></span>
<span><span class="co">#&gt; 4          4.6         3.1          1.5         0.2  setosa  4                1</span></span>
<span><span class="co">#&gt; 5          5.0         3.6          1.4         0.2  setosa  5                0</span></span>
<span><span class="co">#&gt; 6          5.4         3.9          1.7         0.4  setosa  6                1</span></span></code></pre></div>
<p>From this dataframe, we can easily extract a vector of the ids to
sample:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ids_to_sample</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">sample_indicator</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ids_to_sample</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  4  6  8 11 14 15</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids_to_sample</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 40</span></span></code></pre></div>
<p>Note that <code>design_data</code> is the output of
<code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code> in this example, but in practice it
can be any dataframe that has one row per stratum and one column
specifying each stratum’s desired sample size. As such, any method of
allocating samples to strata can be implemented by
<code><a href="../reference/sample_strata.html">sample_strata()</a></code> as long as the design dataframe is
specified and simple random sampling within strata is used.</p>
</div>
<div class="section level2">
<h2 id="adaptive-multi-wave-sampling">Adaptive, Multi-Wave Sampling<a class="anchor" aria-label="anchor" href="#adaptive-multi-wave-sampling"></a>
</h2>
<p>When measuring variables of interest is expensive or difficult, it
can be advantageous to employ a multi-phase design, where cheaper
variables are collected from the entire population and expensive
variables are collected from subsamples selected through adaptive,
multi-wave sampling. This approach, which is documented in McIsaac and
Cook (2015), involves multiple waves of sampling where information from
prior waves is used to inform the optimum sampling design of subsequent
ones. With the understanding that both Neyman and Wright’s optimum
allocation methods depend heavily on standard deviation estimates for
the variable of interest, the benefit of multi-wave sampling is clear to
see. Sample allocations based on prior waves will use updated estimates
of nuisance parameters that incorporate data accumulated in the prior
sampling waves. The optimal sampling proportion is updated at the end of
each wave, and this update guides the sampling of the next wave. As the
phase II data accumulate, the necessary within-strata SD estimates, and
thus the estimated optimal sampling proportions, are expected to be
closer to their true value.</p>
<p>In the design described by McIsaac and Cook, a large phase-I sample
is first taken to measure the inexpensive covariates and/or outcome. The
results of this phase will define strata which are then sampled
non-optimally (through proportional or balanced sampling) for
measurement of the expensive variable in phase-IIa. The phase-IIa
results are used to estimate the standard deviation required to
optimally allocate the next wave of samples. This process is iterated
until the desired sample size for the variable of interest is achieved.
Below is an outline of the workflow, which is facilitated by
<code>optimall</code>: <br><br></p>
<center>
<p><img src="../inst/images/MultiwaveFlowchart.png" style="width:55.0%"></p>
</center>
<p><br></p>
<p><code>optimall</code> allows users to input phase-I data and
iteratively allocate samples for subsequent waves with the function
<code><a href="../reference/allocate_wave.html">allocate_wave()</a></code>. This function runs integer-valued
<code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code> on a dataset according to Wright’s
Algorithm II, but it takes into account previous sampling waves to
determine how the current wave of samples should be allocated.</p>
<p>For a simple example, suppose that we again want to allocate 40
samples to minimize the variance of <code>"Sepal.Width"</code> in the
<code>iris</code> dataset, but 30 out of the 40 have already been
sampled. We assume that the strata are still defined only by
<code>"Species"</code>, and that 16 of the first 30 samples were taken
from the virginica species, 7 from setosa, and 7 from versicolor.
Assuming we only have those 30 samples to base our within-stratum
standard deviation estimates on, we can allocate the next 10 samples
using <code><a href="../reference/allocate_wave.html">allocate_wave()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up Wave 1</span></span>
<span><span class="va">wave1_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"setosa"</span>,</span>
<span>                                       <span class="st">"virginica"</span>,</span>
<span>                                      <span class="st">"versicolor"</span><span class="op">)</span>,</span>
<span>                           stratum_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">16</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Collect Sepal.Width from only the 30 samples</span></span>
<span><span class="va">phase1_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html" class="external-link">iris</a></span>, select <span class="op">=</span>  <span class="op">-</span><span class="va">Sepal.Width</span><span class="op">)</span></span>
<span></span>
<span><span class="va">phase1_data</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">phase1_data</span><span class="op">)</span> <span class="co">#Add id column</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">234</span><span class="op">)</span></span>
<span><span class="va">phase1_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_strata.html">sample_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase1_data</span>, </span>
<span>                               strata <span class="op">=</span> <span class="st">"Species"</span>, id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>                               design_data <span class="op">=</span> <span class="va">wave1_design</span>,</span>
<span>                               design_strata <span class="op">=</span> <span class="st">"strata"</span>,</span>
<span>                               n_allocated <span class="op">=</span> <span class="st">"stratum_size"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wave1_ids</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">phase1_data</span><span class="op">$</span><span class="va">sample_indicator</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">wave1_sampled_data</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">wave1_ids</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>,<span class="st">"Sepal.Width"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">wave1_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">phase1_data</span>, <span class="va">wave1_sampled_data</span>, by <span class="op">=</span> <span class="st">"id"</span>, </span>
<span>                    no.dups <span class="op">=</span>  <span class="cn">TRUE</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We have our 30 samples</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">wave1_data</span><span class="op">$</span><span class="va">Sepal.Width</span><span class="op">)</span>, <span class="va">wave1_data</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></span>
<span><span class="co">#&gt;        </span></span>
<span><span class="co">#&gt;         setosa versicolor virginica</span></span>
<span><span class="co">#&gt;   FALSE      7          7        16</span></span>
<span><span class="co">#&gt;   TRUE      43         43        34</span></span>
<span></span>
<span><span class="co"># Now, allocate the next 10:</span></span>
<span><span class="va">wave2_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/allocate_wave.html">allocate_wave</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">wave1_data</span>,</span>
<span>                              strata <span class="op">=</span> <span class="st">"Species"</span>, </span>
<span>                              y <span class="op">=</span> <span class="st">"Sepal.Width"</span>,</span>
<span>                              already_sampled <span class="op">=</span> <span class="st">"sample_indicator"</span>,</span>
<span>                              nsample <span class="op">=</span> <span class="fl">10</span>, </span>
<span>                              detailed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wave2_design</span></span>
<span><span class="co">#&gt;       strata npop nsample_optimal nsample_actual nsample_prior n_to_sample   sd</span></span>
<span><span class="co">#&gt; 1     setosa   50              19             15             7           8 0.47</span></span>
<span><span class="co">#&gt; 2 versicolor   50              12              9             7           2 0.29</span></span>
<span><span class="co">#&gt; 3  virginica   50               9             16            16           0 0.24</span></span></code></pre></div>
<p>Notice that in this case, <code>"nsample_optimal"</code> does not
match <code>"nsample_actual"</code> for every stratum in the outputted
design dataframe. This occurred because we <em>oversampled</em> from the
virginica stratum in wave 1, meaning that the optimum stratum sample
size among 40 total samples was smaller than the amount of samples
already taken in that group. When oversampling occurs,
<code><a href="../reference/allocate_wave.html">allocate_wave()</a></code> recalculates the optimum allocation among
the non-oversampled strata and uses that result to allocate the
specified number of samples as optimally as possible. When no
oversampling occurs, <code>"nsample_optimal"</code> will match
<code>"nsample_actual"</code> for every stratum.</p>
<p>Now we can easily get the 10 new ids to sample using the
<code>wave2_design</code> as the <code>design_data</code> in
<code><a href="../reference/sample_strata.html">sample_strata()</a></code>. Notice that we do not have to specify
<code>design_strata</code> or <code>n_allocated</code> because the
default arguments are the column names of the
<code><a href="../reference/allocate_wave.html">allocate_wave()</a></code> output:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="co"># Run sample_strata</span></span>
<span><span class="va">wave2_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_strata.html">sample_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">wave1_data</span>, strata <span class="op">=</span> <span class="st">"Species"</span>,</span>
<span>                            id <span class="op">=</span> <span class="st">"id"</span>, already_sampled <span class="op">=</span> <span class="st">"sample_indicator"</span>,</span>
<span>                            design_data <span class="op">=</span> <span class="va">wave2_design</span><span class="op">)</span></span>
<span></span>
<span> <span class="co"># Extract the 10 ids to sample</span></span>
<span><span class="va">wave2_ids</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">wave2_data</span><span class="op">$</span><span class="va">sample_indicator</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">wave2_ids</span></span>
<span><span class="co">#&gt;  [1]  8 15 22 24 26 32 40 47 57 68</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="examples-using-optimall-to-determine-study-design-and-sample-data">Examples: Using <code>optimall</code> to Determine Study Design and
Sample Data<a class="anchor" aria-label="anchor" href="#examples-using-optimall-to-determine-study-design-and-sample-data"></a>
</h2>
<div class="section level4">
<h4 id="overview">
<em>Overview</em><a class="anchor" aria-label="anchor" href="#overview"></a>
</h4>
<p>We use the simulated dataset <code>MatWgt_Sim</code> to demonstrate
how the functions in <code>optimall</code> can be used to carry out
study design and sampling tasks in R. This section includes three
examples, which build upon eachother during the design and execution of
a multi-wave survey:</p>
<ul>
<li><p>Example 1: Uses the function <code><a href="../reference/split_strata.html">split_strata()</a></code> to
define and refine strata.</p></li>
<li><p>Example 2: Uses the function <code><a href="../reference/sample_strata.html">sample_strata()</a></code> to
randomly select units to be sampled based on a specified sampling
design.</p></li>
<li><p>Example 3: Demonstrates how to conduct an adaptive, multi-wave
sampling design that uses an optimal Neyman allocation scheme at each
step to allocate the next wave across strata.</p></li>
</ul>
<p>The dataset contains simulated data based on a real study of the
association between maternal weight gain during pregnancy and the risk
of childhood obesity after controlling for a number of clinical and
demographic covariates. In this hypothetical example, the study data are
obtained from electronic health records, which are known to be
error-prone and do not have all the variables of interested available
without manual chart review. In a perfect world, chart review would be
used to validate and obtain the necessary variables on every observation
in our sample, but chart review is an expensive and difficult task.
Researchers determined that they could only reasonably afford to
validate 750 out of the 10,335 child-mother pairs. We refer to the
10,335 as the phase 1 sample, for which we have error-prone observations
on all, and we refer to the 750 as the phase II sample, which will be
designed using tools in the <code>optimall</code> package. For
simplicity, suppose that we want to use these 750 samples to estimate
the true population mean of maternal weight change during pregnancy with
minimal variance. This goal will be accomplished in our last example
through an adaptive, multi-wave sampling design.</p>
</div>
<div class="section level4">
<h4 id="data-set-up">
<em>Data Set Up</em><a class="anchor" aria-label="anchor" href="#data-set-up"></a>
</h4>
<p>The simulated data used in this example is included with
<code>optimall</code>. The dataset <code>MatWgt_Sim</code> contains
10335 rows, one for each mother-child pair, and 6 columns containing ID
numbers and covariates which we see below:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">MatWgt_Sim</span>, package <span class="op">=</span> <span class="st">"optimall"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">MatWgt_Sim</span><span class="op">)</span></span>
<span><span class="co">#&gt;     id mat_weight_est  race diabetes obesity mat_weight_true</span></span>
<span><span class="co">#&gt; 1 7667      12.954711 Asian        0       0       10.768935</span></span>
<span><span class="co">#&gt; 2 8554       9.607124 Asian        0       1        8.892049</span></span>
<span><span class="co">#&gt; 3 6324      10.998284 Asian        0       0       12.075861</span></span>
<span><span class="co">#&gt; 4 8320      10.702210 Asian        0       0       10.887584</span></span>
<span><span class="co">#&gt; 5 8543       6.485988 Asian        1       0        7.331542</span></span>
<span><span class="co">#&gt; 6  127      13.338445 Asian        0       1       12.936826</span></span></code></pre></div>
<p>Three of the covariates, child race, diabetes, and estimated maternal
weight, are inexpensive to collect for all subjects, but determining the
true maternal weight requires a tedious validation process. This full
version of the simulated dataset contains the true weight change for all
10335 mothers, which may or may not have a relationship with the other
covariates.</p>
<p>For the purpose of our examples, we suppose that we do not have
access to this full dataset. Instead, we must sample from it to
optimally estimate the mean of the true maternal weight changes.</p>
<p>During phase-I, we assume that all 10335 mother-child pairs have been
sampled for the inexpensive covariates. Accordingly, we define our phase
1 dataset to be 10335 x 5 with every column of the full
<code>MatWgt_Sim</code> data excluding the expensive true weight change.
In the examples that follow, we will assume the validated maternal
weight variable <code>mat_weight_true</code> will only be available
through phase 2 sampling.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Get phase 1 data, remove mat_weight_true which we assume is unknown</span></span>
<span><span class="va">phase1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">MatWgt_Sim</span>, select <span class="op">=</span>  <span class="op">-</span><span class="va">mat_weight_true</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">phase1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 10335     5</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-1-defining-sample-strata">
<em>Example 1: Defining Sample Strata</em><a class="anchor" aria-label="anchor" href="#example-1-defining-sample-strata"></a>
</h4>
<p>We suspect that the true mean maternal weight change may vary with
some of the inexpensive covariates in the phase 1 dataset, so we decide
to split our population into 9 non-overlapping strata. Each stratum will
be defined by a unique combination of race and global percentile of
maternal weight gain (≤25th, 25th - 75th, &gt;75th). We can accomplish
this quickly in <code>optimall</code> using the
<code><a href="../reference/split_strata.html">split_strata()</a></code> function.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phase1</span><span class="op">$</span><span class="va">strata</span> <span class="op">&lt;-</span> <span class="va">phase1</span><span class="op">$</span><span class="va">race</span> <span class="co">#initialize a strata column first</span></span>
<span></span>
<span><span class="co"># Merge the smallest race categories</span></span>
<span></span>
<span><span class="va">phase1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_strata.html">merge_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase1</span>, </span>
<span>                          strata <span class="op">=</span> <span class="st">"race"</span>,</span>
<span>                          merge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Other"</span>,<span class="st">"Asian"</span><span class="op">)</span>,</span>
<span>                          name <span class="op">=</span> <span class="st">"Other"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">phase1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/split_strata.html">split_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase1</span>, strata <span class="op">=</span> <span class="st">"new_strata"</span>, split <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                       split_var <span class="op">=</span> <span class="st">"mat_weight_est"</span>, </span>
<span>                       type <span class="op">=</span> <span class="st">"global quantile"</span>, </span>
<span>                       split_at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.75</span><span class="op">)</span>,</span>
<span>                       trunc <span class="op">=</span> <span class="st">"MWC_est"</span><span class="op">)</span></span>
<span><span class="co"># Trunc argument specifies how to refer to mat_weight_est in new strata names</span></span></code></pre></div>
<p>We now have the same <code>phase1</code> data with a new column
specifying the strata we have defined.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">phase1</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   new_strata old_strata   id mat_weight_est diabetes obesity</span></span>
<span><span class="co">#&gt; 1 Other.MWC_est_(9.75,15.06]      Other 7667      12.954711        0       0</span></span>
<span><span class="co">#&gt; 2 Other.MWC_est_[-5.39,9.75]      Other 8554       9.607124        0       1</span></span>
<span><span class="co">#&gt; 3 Other.MWC_est_(9.75,15.06]      Other 6324      10.998284        0       0</span></span>
<span><span class="co">#&gt; 4 Other.MWC_est_(9.75,15.06]      Other 8320      10.702210        0       0</span></span>
<span><span class="co">#&gt; 5 Other.MWC_est_[-5.39,9.75]      Other 8543       6.485988        1       0</span></span>
<span><span class="co">#&gt; 6 Other.MWC_est_(9.75,15.06]      Other  127      13.338445        0       1</span></span>
<span><span class="co">#&gt;   strata</span></span>
<span><span class="co">#&gt; 1  Asian</span></span>
<span><span class="co">#&gt; 2  Asian</span></span>
<span><span class="co">#&gt; 3  Asian</span></span>
<span><span class="co">#&gt; 4  Asian</span></span>
<span><span class="co">#&gt; 5  Asian</span></span>
<span><span class="co">#&gt; 6  Asian</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">phase1</span><span class="op">$</span><span class="va">new_strata</span><span class="op">)</span> <span class="co"># 9 strata</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Black.MWC_est_(15.06,38.46]  Black.MWC_est_(9.75,15.06] </span></span>
<span><span class="co">#&gt;                         628                        1154 </span></span>
<span><span class="co">#&gt; Black.MWC_est_[-30.21,9.75] Other.MWC_est_(15.06,30.94] </span></span>
<span><span class="co">#&gt;                         745                         325 </span></span>
<span><span class="co">#&gt;  Other.MWC_est_(9.75,15.06]  Other.MWC_est_[-5.39,9.75] </span></span>
<span><span class="co">#&gt;                         929                         456 </span></span>
<span><span class="co">#&gt; White.MWC_est_(15.06,51.69]  White.MWC_est_(9.75,15.06] </span></span>
<span><span class="co">#&gt;                        1631                        3084 </span></span>
<span><span class="co">#&gt; White.MWC_est_[-25.68,9.75] </span></span>
<span><span class="co">#&gt;                        1383</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-2-create-an-initial-phase-2-subsample-phase-iia">
<em>Example 2: Create an Initial Phase 2 Subsample:
Phase-IIa</em><a class="anchor" aria-label="anchor" href="#example-2-create-an-initial-phase-2-subsample-phase-iia"></a>
</h4>
<p>With the strata now defined by the inexpensive variables sampled in
phase-I, we are ready to begin auditing patient records for validation
of the true maternal weight changes. Without any validated data to
define the optimum phase-IIa sample allocation, we decide to use
proportional stratified sampling for the first 250 out of our 750
audits. Conveniently, <code>optimall</code> can select this random
sample for us with <code><a href="../reference/sample_strata.html">sample_strata()</a></code>.</p>
<p>The <code><a href="../reference/sample_strata.html">sample_strata()</a></code> function requires as input two
dataframes, one containing the stratum membership of each individual
unit (<code>data</code>) and a second specifying the sampling design
(<code>design_data</code>). The <code>design_data</code> dataframe must
contain at least two columns:</p>
<ul>
<li>
<code>design_strata</code>: A column holding strata names</li>
<li>
<code>n_allocated</code>: The total <span class="math inline">\(n\)</span> allocated to each stratum.</li>
</ul>
<p>In our example, we want the proportion of samples randomly taken from
each stratum to reflect its population proportion and a total of 250
samples.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phase2a_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  strata_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">phase1</span><span class="op">$</span><span class="va">new_strata</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  strata_prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">phase1</span><span class="op">$</span><span class="va">new_strata</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">10335</span>,</span>
<span>  strata_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">250.3</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">phase1</span><span class="op">$</span><span class="va">new_strata</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">10335</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="co"># 250.3 to make sure 250 samples after rounding</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">phase2a_design</span><span class="op">$</span><span class="va">strata_n</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] 250</span></span>
<span><span class="va">phase2a_design</span></span>
<span><span class="co">#&gt;                   strata_name strata_prop strata_n</span></span>
<span><span class="co">#&gt; 1 Black.MWC_est_(15.06,38.46]  0.06076439       15</span></span>
<span><span class="co">#&gt; 2  Black.MWC_est_(9.75,15.06]  0.11165941       28</span></span>
<span><span class="co">#&gt; 3 Black.MWC_est_[-30.21,9.75]  0.07208515       18</span></span>
<span><span class="co">#&gt; 4 Other.MWC_est_(15.06,30.94]  0.03144654        8</span></span>
<span><span class="co">#&gt; 5  Other.MWC_est_(9.75,15.06]  0.08988873       22</span></span>
<span><span class="co">#&gt; 6  Other.MWC_est_[-5.39,9.75]  0.04412192       11</span></span>
<span><span class="co">#&gt; 7 White.MWC_est_(15.06,51.69]  0.15781326       40</span></span>
<span><span class="co">#&gt; 8  White.MWC_est_(9.75,15.06]  0.29840348       75</span></span>
<span><span class="co">#&gt; 9 White.MWC_est_[-25.68,9.75]  0.13381713       33</span></span></code></pre></div>
<p>We can now call <code><a href="../reference/sample_strata.html">sample_strata()</a></code> to randomly draw the
specified number samples from each stratum. It will output the same
<code>phase1</code> dataframe with an extra column indicating which
units should be sampled. We can then extract the ids to sample based on
this indicator.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phase1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_strata.html">sample_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase1</span>, strata <span class="op">=</span> <span class="st">"new_strata"</span>, </span>
<span>                        id <span class="op">=</span> <span class="st">"id"</span>, design_data <span class="op">=</span> <span class="va">phase2a_design</span>, </span>
<span>                        design_strata <span class="op">=</span> <span class="st">"strata_name"</span>, </span>
<span>                        n_allocated <span class="op">=</span> <span class="st">"strata_n"</span><span class="op">)</span></span>
<span><span class="va">ids_to_sample2a</span> <span class="op">&lt;-</span> <span class="va">phase1</span><span class="op">[</span><span class="va">phase1</span><span class="op">$</span><span class="va">sample_indicator</span> <span class="op">==</span> <span class="fl">1</span>,<span class="st">"id"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids_to_sample2a</span><span class="op">)</span> <span class="co"># 250 ids to sample</span></span>
<span><span class="co">#&gt; [1] 250</span></span></code></pre></div>
<p>We submit these 250 ids for validation. Hypothetically, this involves
the hard work of trained nurses, but for our example it involves only a
few lines of code.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phase2a_samples</span> <span class="op">&lt;-</span> <span class="va">MatWgt_Sim</span><span class="op">[</span><span class="va">MatWgt_Sim</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_to_sample2a</span>, </span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>,<span class="st">"mat_weight_true"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">phase2a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">phase1</span>, <span class="va">phase2a_samples</span>, by <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>                 no.dups <span class="op">=</span>  <span class="cn">TRUE</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">phase2a</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "id"               "new_strata"       "old_strata"       "mat_weight_est"  </span></span>
<span><span class="co">#&gt; [5] "diabetes"         "obesity"          "strata"           "sample_indicator"</span></span>
<span><span class="co">#&gt; [9] "mat_weight_true"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">phase2a</span><span class="op">$</span><span class="va">mat_weight_true</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; FALSE  TRUE </span></span>
<span><span class="co">#&gt;   250 10085</span></span></code></pre></div>
<p>We notice that all of the units that were not validated have
<code>NA</code> values in the new columns. We will use the non-missing
validated data to inform optimum allocation in our future sampling
waves.</p>
</div>
<div class="section level4">
<h4 id="example-3-optimally-allocate-2nd-and-3rd-waves-of-phase-2-sample">
<em>Example 3: Optimally Allocate 2nd and 3rd Waves of Phase 2
Sample</em><a class="anchor" aria-label="anchor" href="#example-3-optimally-allocate-2nd-and-3rd-waves-of-phase-2-sample"></a>
</h4>
<p>In phase-IIa, we allocated samples to strata using proportional
sampling rather than optimum allocation because we had no prior samples
of the true maternal weight change from which to estimate within-stratum
variances. Now that we have completed the first wave of validation, we
can estimate these variances and will thus use optimum allocation for
each of the subsequent sampling waves.</p>
<p>In phase-IIb (wave 2), we will optimally allocate 250 more samples,
raising our total number of validated samples to 500. The
<code><a href="../reference/allocate_wave.html">allocate_wave()</a></code> function makes this step simple by
calculating the optimum allocation for 500 samples, determining how many
units have already been sampled in previous waves (only Phase-IIa in
this case), and allocating the 250 samples of the current wave to make
up the difference. The output is a design dataframe summarizing the
results for each stratum.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phase2b</span> <span class="op">&lt;-</span> <span class="va">phase2a</span></span>
<span></span>
<span><span class="co"># Add indicator for units that were already sampled</span></span>
<span><span class="va">phase2b</span><span class="op">$</span><span class="va">already_sampled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">phase2b</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_to_sample2a</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make design </span></span>
<span><span class="va">phase2b_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/allocate_wave.html">allocate_wave</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase2b</span>, strata <span class="op">=</span> <span class="st">"new_strata"</span>,</span>
<span>                             y <span class="op">=</span> <span class="st">"mat_weight_true"</span>,</span>
<span>                             already_sampled <span class="op">=</span> <span class="st">"already_sampled"</span>, </span>
<span>                             nsample <span class="op">=</span> <span class="fl">250</span>,</span>
<span>                             detailed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">phase2b_design</span></span>
<span><span class="co">#&gt;                        strata npop nsample_optimal nsample_actual nsample_prior</span></span>
<span><span class="co">#&gt; 1 Black.MWC_est_(15.06,38.46]  628              46             46            15</span></span>
<span><span class="co">#&gt; 2  Black.MWC_est_(9.75,15.06] 1154              38             38            28</span></span>
<span><span class="co">#&gt; 3 Black.MWC_est_[-30.21,9.75]  745              52             52            18</span></span>
<span><span class="co">#&gt; 4 Other.MWC_est_(15.06,30.94]  325              12             12             8</span></span>
<span><span class="co">#&gt; 5  Other.MWC_est_(9.75,15.06]  929              34             34            22</span></span>
<span><span class="co">#&gt; 6  Other.MWC_est_[-5.39,9.75]  456              30             30            11</span></span>
<span><span class="co">#&gt; 7 White.MWC_est_(15.06,51.69] 1631              83             83            40</span></span>
<span><span class="co">#&gt; 8  White.MWC_est_(9.75,15.06] 3084             117            117            75</span></span>
<span><span class="co">#&gt; 9 White.MWC_est_[-25.68,9.75] 1383              88             88            33</span></span>
<span><span class="co">#&gt;   n_to_sample   sd</span></span>
<span><span class="co">#&gt; 1          31 3.51</span></span>
<span><span class="co">#&gt; 2          10 1.58</span></span>
<span><span class="co">#&gt; 3          34 3.32</span></span>
<span><span class="co">#&gt; 4           4 1.75</span></span>
<span><span class="co">#&gt; 5          12 1.73</span></span>
<span><span class="co">#&gt; 6          19 3.18</span></span>
<span><span class="co">#&gt; 7          43 2.44</span></span>
<span><span class="co">#&gt; 8          42 1.80</span></span>
<span><span class="co">#&gt; 9          55 3.04</span></span></code></pre></div>
<p>Looking at the output of <code><a href="../reference/allocate_wave.html">allocate_wave()</a></code>, we notice that
the optimum sample sizes for the next wave vary greatly between strata,
but all are greater than one. Because we set
<code>detailed = TRUE</code>, we can also see what the optimum
allocation for 500 samples would have been ignoring prior wave sizes in
the column <code>"nsample_optimal"</code>. This column matches
<code>"nsample_actual"</code> because we did not oversample any strata
in phase-IIa.</p>
<p>In other cases when <code>"n_to_sample"</code> = 0 for some strata,
we may not be so lucky. If the optimum sample size in a stratum is
smaller than the amount it was allocated in previous waves
(<code>"nsample_prior"</code>), we say that that stratum has been
oversampled. When oversampling occurs, <code><a href="../reference/allocate_wave.html">allocate_wave()</a></code>
“closes” the oversampled strata and re-allocates the remaining samples
optimally among the open strata. Under these circumstances, the total
sampling allocation is no longer optimal, but <code>optimall</code> will
output the most optimal allocation from the non-oversampled strata for
the next wave.</p>
<p>Although we don’t see evidence of oversampling, these results suggest
that our strata are relatively imbalanced. We decide to split the
largest stratum into three similarly-sized strata along mat_weight_est
using the <code>local quantile</code> option of
<code><a href="../reference/split_strata.html">split_strata()</a></code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phase2b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/split_strata.html">split_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase2b</span>, </span>
<span>                        split <span class="op">=</span> <span class="st">"White.MWC_est_(9.75,15.06]"</span>,</span>
<span>                        strata <span class="op">=</span> <span class="st">"new_strata"</span>, </span>
<span>                        split_var <span class="op">=</span> <span class="st">"mat_weight_est"</span>,</span>
<span>                        type <span class="op">=</span> <span class="st">"local quantile"</span>, split_at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>With our strata now more balanced in size, we can re-run
<code><a href="../reference/allocate_wave.html">allocate_wave()</a></code> to make a new design dataframe for
<code><a href="../reference/sample_strata.html">sample_strata()</a></code> to use to determine which ids to sample in
phase-IIb.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phase2b_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/allocate_wave.html">allocate_wave</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase2b</span>, </span>
<span>                             strata <span class="op">=</span> <span class="st">"new_strata"</span>,</span>
<span>                             y <span class="op">=</span> <span class="st">"mat_weight_true"</span>,</span>
<span>                             already_sampled <span class="op">=</span> <span class="st">"already_sampled"</span>,</span>
<span>                             nsample <span class="op">=</span> <span class="fl">250</span><span class="op">)</span></span>
<span><span class="va">phase2b_design</span></span>
<span><span class="co">#&gt;                                                     strata npop nsample_actual</span></span>
<span><span class="co">#&gt; 1                              Black.MWC_est_(15.06,38.46]  628             49</span></span>
<span><span class="co">#&gt; 2                               Black.MWC_est_(9.75,15.06] 1154             40</span></span>
<span><span class="co">#&gt; 3                              Black.MWC_est_[-30.21,9.75]  745             55</span></span>
<span><span class="co">#&gt; 4                              Other.MWC_est_(15.06,30.94]  325             13</span></span>
<span><span class="co">#&gt; 5                               Other.MWC_est_(9.75,15.06]  929             35</span></span>
<span><span class="co">#&gt; 6                               Other.MWC_est_[-5.39,9.75]  456             32</span></span>
<span><span class="co">#&gt; 7                              White.MWC_est_(15.06,51.69] 1631             88</span></span>
<span><span class="co">#&gt; 8  White.MWC_est_(9.75,15.06].mat_weight_est_(11.44,12.99] 1028             29</span></span>
<span><span class="co">#&gt; 9  White.MWC_est_(9.75,15.06].mat_weight_est_(12.99,15.05] 1028             39</span></span>
<span><span class="co">#&gt; 10  White.MWC_est_(9.75,15.06].mat_weight_est_[9.75,11.44] 1028             28</span></span>
<span><span class="co">#&gt; 11                             White.MWC_est_[-25.68,9.75] 1383             92</span></span>
<span><span class="co">#&gt;    nsample_prior n_to_sample</span></span>
<span><span class="co">#&gt; 1             15          34</span></span>
<span><span class="co">#&gt; 2             28          12</span></span>
<span><span class="co">#&gt; 3             18          37</span></span>
<span><span class="co">#&gt; 4              8           5</span></span>
<span><span class="co">#&gt; 5             22          13</span></span>
<span><span class="co">#&gt; 6             11          21</span></span>
<span><span class="co">#&gt; 7             40          48</span></span>
<span><span class="co">#&gt; 8             29           0</span></span>
<span><span class="co">#&gt; 9             21          18</span></span>
<span><span class="co">#&gt; 10            25           3</span></span>
<span><span class="co">#&gt; 11            33          59</span></span>
<span></span>
<span><span class="co"># Extract IDs to sample</span></span>
<span><span class="va">ids_to_sample2b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_strata.html">sample_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase2b</span>, </span>
<span>                                 strata <span class="op">=</span> <span class="st">"new_strata"</span>, </span>
<span>                                 id <span class="op">=</span> <span class="st">"id"</span>, </span>
<span>                                 already_sampled <span class="op">=</span> <span class="st">"already_sampled"</span>, </span>
<span>                                 design_data <span class="op">=</span> <span class="va">phase2b_design</span>,</span>
<span>                                 design_strata <span class="op">=</span> <span class="st">"strata"</span>, </span>
<span>                                 n_allocated <span class="op">=</span> <span class="st">"n_to_sample"</span><span class="op">)</span></span>
<span><span class="va">ids_to_sample2b</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">ids_to_sample2b</span><span class="op">[</span><span class="va">ids_to_sample2b</span><span class="op">$</span><span class="va">sample_indicator</span> <span class="op">==</span> <span class="fl">1</span>,<span class="st">"id"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids_to_sample2b</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 250</span></span></code></pre></div>
<p>We can now get the validated maternal weight changes for these 250
subjects.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Take samples from true data</span></span>
<span><span class="va">phase2b_samples</span> <span class="op">&lt;-</span> <span class="va">MatWgt_Sim</span><span class="op">[</span><span class="va">MatWgt_Sim</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_to_sample2b</span>,</span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>,<span class="st">"mat_weight_true"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Merge extracted samples with our data.</span></span>
<span><span class="co"># Note we use dplyr's coalesce here to merge sampled mat_weight_true with </span></span>
<span><span class="co"># the mat_weight_true solumn already present in phase2b, but manner of </span></span>
<span><span class="co"># merging of samples may vary from project to project.</span></span>
<span><span class="co"># For simpler merges, see 'Multiwave Object' vignette.</span></span>
<span></span>
<span><span class="va">phase2b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">phase2b</span>, <span class="va">phase2b_samples</span>, by <span class="op">=</span> <span class="st">"id"</span>, </span>
<span>                 no.dups <span class="op">=</span> <span class="cn">TRUE</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">phase2b</span><span class="op">$</span><span class="va">mat_weight_true</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">phase2b</span><span class="op">$</span><span class="va">mat_weight_true.x</span>,</span>
<span>                  <span class="va">phase2b</span><span class="op">$</span><span class="va">mat_weight_true.y</span><span class="op">)</span></span>
<span><span class="va">phase2b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">phase2b</span>, select <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mat_weight_true.x</span>,</span>
<span>                                       <span class="va">mat_weight_true.y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">phase2b</span><span class="op">$</span><span class="va">mat_weight_true</span><span class="op">)</span><span class="op">)</span> <span class="co"># All are NA besides already sampled.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; FALSE  TRUE </span></span>
<span><span class="co">#&gt;   500  9835</span></span></code></pre></div>
<p>With these results in, we can move onto our final wave.</p>
</div>
<div class="section level4">
<h4 id="phase-iic">
<em>Phase-IIc</em><a class="anchor" aria-label="anchor" href="#phase-iic"></a>
</h4>
<p>After auditing the 250 additional samples in Phase-IIb, we only have
250 left to validate until we reach our goal of 750. We will combine
what we have learned in the previous waves of phase-II to optimally
assign these final 250 samples in phase-IIc.</p>
<p>Following the same steps as in phase-IIb, we use
<code><a href="../reference/allocate_wave.html">allocate_wave()</a></code> to find the optimum sample sizes in each
stratum based on estimates of the variance using our previous samples.
We then determine which ids to sample using
<code><a href="../reference/sample_strata.html">sample_strata()</a></code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phase2c</span> <span class="op">&lt;-</span> <span class="va">phase2b</span></span>
<span></span>
<span><span class="co"># Add indicator for units that were already sampled</span></span>
<span><span class="va">phase2c</span><span class="op">$</span><span class="va">already_sampled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">phase2b</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ids_to_sample2a</span>,</span>
<span>                                                    <span class="va">ids_to_sample2b</span><span class="op">)</span>, </span>
<span>                                  <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make Design</span></span>
<span><span class="va">phase2c_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/allocate_wave.html">allocate_wave</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase2c</span>, strata <span class="op">=</span> <span class="st">"new_strata"</span>,</span>
<span>                             y <span class="op">=</span> <span class="st">"mat_weight_true"</span>,</span>
<span>                             already_sampled <span class="op">=</span> <span class="st">"already_sampled"</span>, </span>
<span>                             nsample <span class="op">=</span> <span class="fl">250</span>,</span>
<span>                             detailed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">phase2c_design</span></span>
<span><span class="co">#&gt;                                                     strata npop nsample_optimal</span></span>
<span><span class="co">#&gt; 1                              Black.MWC_est_(15.06,38.46]  628              60</span></span>
<span><span class="co">#&gt; 2                               Black.MWC_est_(9.75,15.06] 1154              56</span></span>
<span><span class="co">#&gt; 3                              Black.MWC_est_[-30.21,9.75]  745              99</span></span>
<span><span class="co">#&gt; 4                              Other.MWC_est_(15.06,30.94]  325              18</span></span>
<span><span class="co">#&gt; 5                               Other.MWC_est_(9.75,15.06]  929              50</span></span>
<span><span class="co">#&gt; 6                               Other.MWC_est_[-5.39,9.75]  456              35</span></span>
<span><span class="co">#&gt; 7                              White.MWC_est_(15.06,51.69] 1631             176</span></span>
<span><span class="co">#&gt; 8  White.MWC_est_(9.75,15.06].mat_weight_est_(11.44,12.99] 1028              38</span></span>
<span><span class="co">#&gt; 9  White.MWC_est_(9.75,15.06].mat_weight_est_(12.99,15.05] 1028              48</span></span>
<span><span class="co">#&gt; 10  White.MWC_est_(9.75,15.06].mat_weight_est_[9.75,11.44] 1028              37</span></span>
<span><span class="co">#&gt; 11                             White.MWC_est_[-25.68,9.75] 1383             133</span></span>
<span><span class="co">#&gt;    nsample_actual nsample_prior n_to_sample   sd</span></span>
<span><span class="co">#&gt; 1              60            49          11 3.07</span></span>
<span><span class="co">#&gt; 2              56            40          16 1.56</span></span>
<span><span class="co">#&gt; 3              99            55          44 4.29</span></span>
<span><span class="co">#&gt; 4              18            13           5 1.83</span></span>
<span><span class="co">#&gt; 5              50            35          15 1.74</span></span>
<span><span class="co">#&gt; 6              35            32           3 2.47</span></span>
<span><span class="co">#&gt; 7             176            88          88 3.50</span></span>
<span><span class="co">#&gt; 8              38            29           9 1.20</span></span>
<span><span class="co">#&gt; 9              48            39           9 1.50</span></span>
<span><span class="co">#&gt; 10             37            28           9 1.16</span></span>
<span><span class="co">#&gt; 11            133            92          41 3.12</span></span>
<span></span>
<span><span class="co"># Find IDs to sample</span></span>
<span><span class="va">ids_to_sample2c</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_strata.html">sample_strata</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase2c</span>, </span>
<span>                                 strata <span class="op">=</span> <span class="st">"new_strata"</span>, </span>
<span>                                 id <span class="op">=</span> <span class="st">"id"</span>, </span>
<span>                                 already_sampled <span class="op">=</span> <span class="st">"already_sampled"</span>, </span>
<span>                                 design_data <span class="op">=</span> <span class="va">phase2c_design</span>,</span>
<span>                                 design_strata <span class="op">=</span> <span class="st">"strata"</span>, </span>
<span>                                 n_allocated <span class="op">=</span> <span class="st">"n_to_sample"</span><span class="op">)</span></span>
<span><span class="va">ids_to_sample2c</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">ids_to_sample2c</span><span class="op">[</span><span class="va">ids_to_sample2c</span><span class="op">$</span><span class="va">sample_indicator</span> <span class="op">==</span> <span class="fl">1</span>,<span class="st">"id"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids_to_sample2c</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 250</span></span>
<span></span>
<span><span class="co"># Sample</span></span>
<span><span class="va">phase2c_samples</span> <span class="op">&lt;-</span> <span class="va">MatWgt_Sim</span><span class="op">[</span><span class="va">MatWgt_Sim</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_to_sample2c</span>,</span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>,<span class="st">"mat_weight_true"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Add samples to phase2c dataset</span></span>
<span><span class="va">phase2c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">phase2c</span>, <span class="va">phase2c_samples</span>, by <span class="op">=</span> <span class="st">"id"</span>, </span>
<span>                 no.dups <span class="op">=</span> <span class="cn">TRUE</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">phase2c</span><span class="op">$</span><span class="va">mat_weight_true</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">phase2c</span><span class="op">$</span><span class="va">mat_weight_true.x</span>,</span>
<span>                  <span class="va">phase2c</span><span class="op">$</span><span class="va">mat_weight_true.y</span><span class="op">)</span></span>
<span><span class="va">phase2c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">phase2c</span>, select <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mat_weight_true.x</span>,</span>
<span>                                       <span class="va">mat_weight_true.y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We have now validated 750 samples!</p>
<p>As this example shows, there are quite a few moving parts to keep
track of in the multi-wave sampling workflow. When performing a
multi-wave sampling design, you may also want to consider using
<code>optimall's</code> multiwave object to organize and visualize the
process. This feature is described in detail in the package vignette
titled “The Multiwave Object”.</p>
</div>
</div>
<div class="section level2">
<h2 id="splitting-strata-efficiently-with-optimall_shiny">Splitting Strata Efficiently with <code>optimall_shiny()</code><a class="anchor" aria-label="anchor" href="#splitting-strata-efficiently-with-optimall_shiny"></a>
</h2>
<p>In many cases, deciding which strata to split and where is a
difficult task. <code><a href="../reference/split_strata.html">split_strata()</a></code> makes this job easier, but
it is designed for situations where the strata and split values have
already been decided by the user. Running it iteratively to experiment
with different splits is possible yet tedious.</p>
To help users make these difficult decisions, <code>optimall</code>
includes an R Shiny application that reacts in real time to user
selections of splitting parameters. It can be called using
<code><a href="../reference/optimall_shiny.html">optimall_shiny()</a></code>. See the screenshot below:
<center>
<br><img src="../inst/shiny-app/optimall_shiny/Screenshots/Screenshot1.png" style="width:80.0%">
</center>
<p><br> Each time the user updates an input, the parameters of the
<code><a href="../reference/split_strata.html">split_strata()</a></code> function are updated accordingly, and the
resulting dataframe showing the optimum allocation of samples among the
new strata is displayed. Once the user is satsfied with a set of inputs,
they can <code>confirm</code> the split and the underlying data will be
updated. The code used to perform the split will also be displayed.</p>
<p>Note that the data in the Shiny App has to be loaded in from a file,
and it is thus separate from data being used in the
<code>optimall</code> workflow. This means that the user has to return
to their R session to make the changes determined in the Shiny app. The
app, however, makes this easy by printing the code to perform all of the
confirmed changes, so making them in R is as easy as copying and
pasting. You may have to update the <code>"data"</code> argument.</p>
<p>For more information on <code>optimall_shiny</code> see the package
vignette titled “Splitting Strata with Optimall Shiny”.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>McIsaac MA, Cook RJ. Adaptive sampling in two‐phase designs: a
biomarker study for progression in arthritis. Statistics in Medicine.
2015 Sep 20;34(21):2899-912.</p>
<p>Wright, T. A simple method of exact optimal sample allocation under
stratification with any mixed constraint patterns.2014; Statistics,
07.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jasper Yang, Pamela Shaw.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
