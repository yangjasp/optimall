<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="optimall">
<title>Estimation in Two-phase, Multi-wave sampling • optimall</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimation in Two-phase, Multi-wave sampling">
<meta property="og:description" content="optimall">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">optimall</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Multiwave-Estimation.html">Estimation in Two-phase, Multi-wave sampling</a>
    <a class="dropdown-item" href="../articles/Multiwave-Object.html">Multiwave Object</a>
    <a class="dropdown-item" href="../articles/optimall-vignette.html">Using Optimall</a>
    <a class="dropdown-item" href="../articles/using-optimall_shiny.html">Splitting Strata with Optimall Shiny</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/yangjasp/optimall/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Estimation in Two-phase, Multi-wave sampling</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/yangjasp/optimall/blob/HEAD/vignettes/Multiwave-Estimation.Rmd" class="external-link"><code>vignettes/Multiwave-Estimation.Rmd</code></a></small>
      <div class="d-none name"><code>Multiwave-Estimation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Two-phase, multi-wave sampling is an appealing strategy for the
design of validation studies where a large set of data is available for
a whole cohort, but some variables of interest can only be observed on a
subset of the cohort. A classic example is when inexpensive error-prone
data is available on everyone (phase I), but the error-free or gold
standard data is only available on a subset (phase II) (McIsaac and Cook
2015, Chen and Lumley 2020, Shepherd et al. 2023).</p>
<p>One of <code>optimall</code>’s primary objectives is to facilitate
the implementation of two-phase, multi-wave sampling designs in
<code>R</code>, focusing particularly on the optimum allocation of
samples, stratification, and storage of relevant information during the
design stage. The <code>optimall</code> workflow is designed to blend
smoothly with packages specific to the estimation stage, such as the
comprehensive <code>survey</code> package, so <code>optimall</code>
itself does not offer functions for estimation.</p>
<p>Nevertheless, estimation is the ultimate goal of a survey. This
vignette describes how estimation with the <code>survey</code> package
can be conducted from a survey designed with <code>optimall</code>. It
begins with a brief summary of the theoretical considerations for
multi-phase and multi-wave sampling. It then presents two estimators
that can be used in these settings and demonstrates how they can be
calculated using <code>optimall</code> and <code>survey</code>. The
final section presents the results of simulations comparing these
estimators. In most cases, post-stratified weights lead to the most
efficient estimators.</p>
</div>
<div class="section level2">
<h2 id="theoretical-background">Theoretical background<a class="anchor" aria-label="anchor" href="#theoretical-background"></a>
</h2>
<div class="section level4">
<h4 id="design-based-estimation-ipw-and-generalized-raking-in-a-single-phase-wave">Design-based estimation: IPW and Generalized Raking in a Single
Phase, Wave<a class="anchor" aria-label="anchor" href="#design-based-estimation-ipw-and-generalized-raking-in-a-single-phase-wave"></a>
</h4>
<p>Broadly, there are two classes of survey estimators: design-based and
model-based. This vignette focuses on design-based estimators, which are
typically constructed by assigning weights to sample observations based
on probabilistic properties of the sampling design. A simple example of
a design-based estimator for a single phase design is the
Horwitz-Thompson inverse probability weighted (IPW) estimator for a
population total <span class="math inline">\(Y_t\)</span>,</p>
<p><span class="math display">\[
\hat{T}_{IPW} = \sum_{i =1}^N R_i\frac{y_i}{\pi_i},
\]</span> where individuals in the poulation of size <span class="math inline">\(N\)</span> are indexed by <span class="math inline">\(i = 1, ..., N\)</span>, <span class="math inline">\(R_i\)</span> is an indicator for the inclusion of
individual <span class="math inline">\(i\)</span> in the sample, <span class="math inline">\(\pi_i\)</span> is the sampling probability for
person <span class="math inline">\(i\)</span>, and <span class="math inline">\(y_i\)</span> is the observed value. Under simple
stratified sampling, <span class="math inline">\(\pi_i =
\frac{n_k}{N_k}\)</span> for individuals in the same stratum, <span class="math inline">\(k= 1, ..., K\)</span>, where <span class="math inline">\(n_k\)</span> denotes the sample size in stratum
<span class="math inline">\(k\)</span> and <span class="math inline">\(N_k\)</span> denotes the population size of
stratum <span class="math inline">\(h\)</span>. In this case, the IPW
estimator becomes</p>
<p><span class="math display">\[
\hat{T}_{IPW} = \sum_{k=1}^K\sum_{i \in I_k}R_i\frac{N_k}{n_k}y_i,
\]</span> where <span class="math inline">\(I_k\)</span> is the set of
indices for individuals in stratum <span class="math inline">\(k\)</span>. This estimator is unbiased for the
population total, but its variance may be large if sampling fractions
are small in any strata. The Neyman and Wright allocations which can be
implemented in <code>optimall</code> are optimal for this estimator.</p>
<p>Efficient alternatives to IPW estimators exist when prior information
on the entire population is available. A popular design-based estimator
in the presence of known auxiliary variables is the generalized raking
estimator, which improves on IPW by adjusting weights to ensure that the
estimated totals of auxiliary variables match the known phase 1 totals
(Breslow et al. 2009). Let <span class="math inline">\(x_i\)</span> be
an auxilary variable which was observed for the whole phase 1 cohort and
is correlated with the variable of interest <span class="math inline">\(y_i\)</span>. Generalized raking adjusts each
individual inverse-probability weight by a factor of <span class="math inline">\(g_i\)</span>. Under simple stratified sampling, we
have <span class="math inline">\(w^*_i = \frac{g_i}{\pi_i} =
g_i\frac{N_k}{n_k}\)</span> and the estimator is</p>
<p><span class="math display">\[
\hat{T}_{GR} = \sum_{k=1}^K\sum_{i \in I_k}R_iw^*_iy_i =
\sum_{k=1}^K\sum_{i \in I_k}R_ig_i\frac{N_k}{n_k}y_i ,
\]</span> where the <span class="math inline">\(g_i\)</span> are chosen
such that</p>
<p><span class="math display">\[
\sum_{k=1}^K\sum_{i \in I_k}R_ig_i\frac{N_k}{n_k}x_i = \sum_{i=1}^N x_i
\]</span></p>
<p>Many <span class="math inline">\(g_i\)</span> values may satisfy this
condition, so the new weights are chosen to be as close as possible to
the IPW weights based on minimization of a pre-specified distance metric
<span class="math inline">\(\sum_{i=1}^NR_id(g_i\frac{1}{\pi_i},
\frac{1}{\pi_i})\)</span>.</p>
<p>When the auxiliary variable is correlated with the variable of
interest, generalized raking is more efficient than traditional IPW
estimators. Neyman and Wright allocations are nearly optimal for
generalized raking (Chen and Lumley 2022).</p>
</div>
<div class="section level4">
<h4 id="special-considerations-for-two-phase-sampling">Special considerations for Two-phase sampling<a class="anchor" aria-label="anchor" href="#special-considerations-for-two-phase-sampling"></a>
</h4>
<p>Two-phase sampling involves collecting a large sample of relatively
inexpensive variables in phase 1 and then collecting expensive variables
on a subset of the phase 1 samples in phase 2. Rather than treating the
phase 1 cohort as the population and phase 2 as a single sample from it,
the typical two-phase approach considers phase 1 itself to be a sample
from an even larger super-population of interest. A key feature of
two-phase sampling is that the information collected in phase 1 is used
to inform a more efficient phase 2 sampling design. For example,
standard deviation estimates required for Neyman allocation of phase 2
can be approximated by phase 1 (Neyman 1938). A side effect of this gain
in efficiency is that the marginal inclusion probabilities, <span class="math inline">\(\pi_i\)</span>, for elements sampled in phase 2
are unknown because their calculation requires consideration of the
phase 2 sampling designs that would arise under every possible phase 1.
Specifically, the exact inclusion probability <span class="math inline">\(\pi_i\)</span> in a two-phase design is</p>
<p><span class="math display">\[
\pi_i = \sum_{s_a}R_{ai} P(s_a)\pi_{i|s_a}
\]</span></p>
<p>where <span class="math inline">\(s_a\)</span> is a phase 1 sample,
<span class="math inline">\(P(s_a)\)</span> is the probability of a
given <span class="math inline">\(s_a\)</span> being realized, and <span class="math inline">\(R_{ai}\)</span> is an indicator for the inclusion
of element <span class="math inline">\(i\)</span> in a given phase 1
sample</p>
<p>Because <span class="math inline">\(\pi_i|{s_a}\)</span> depends on
the results of <span class="math inline">\(s_a\)</span>, <span class="math inline">\(\pi_i|{s_a}\)</span> is only known for the
realized <span class="math inline">\(s_a\)</span>. This limitation make
standard IPW techniques infeasible in the two phase setting, so other
approaches are required to construct unbiased estimators and approximate
their variances. Chapter 9 of Särndal et al. (1992) details the special
considerations required to construct such estimators. Here, we briefly
describe their most important results for the case where stratified
random sampling is used in phase 2 based on strata defined from phase 1
variables.</p>
<p>Consider strata <span class="math inline">\(k = 1,...,K\)</span>. Let
<span class="math inline">\(N\)</span> be the population size, <span class="math inline">\(n_a\)</span> be the phase 1 sample size, and <span class="math inline">\(n\)</span> be the phase 2 sample size. Denote
<span class="math inline">\(n_{ak}\)</span> and <span class="math inline">\(n_k\)</span> for the phase 1 and phase 2 sample
sizes respectively in stratum <span class="math inline">\(k\)</span>. An
unbiased design-based estimator for the population total of <span class="math inline">\(T = \sum_{i=1}^N y_i\)</span> is</p>
<p><span class="math display">\[\begin{equation}
\tag{1} \label{eq:eq1}
\hat{T}_{TP} = \sum_{i \in I_{s_a}}\frac{1}{\pi_{ai}\pi_{i|s_a}}y_i,
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\pi_{ai}\)</span> is the phase 1
sampling probability for element <span class="math inline">\(i\)</span>,
<span class="math inline">\(\pi_{i|s_1}\)</span> is the phase 2 sampling
probability given the realized phase 1 sample, denoted <span class="math inline">\(s_a\)</span>, and <span class="math inline">\(I_{s_a}\)</span> is the set of indices for
individuals sampled in <span class="math inline">\(s_a\)</span>. The
idea of this estimator is to estimate the IPW estimator that would have
been produced if <span class="math inline">\(y_i\)</span> was observed
for the entire phase 1 sample <span class="math inline">\(s_a\)</span>.
In this sense, <span class="math inline">\(\hat{T}_{TP}\)</span> is an
estimator of an estimator. Accordingly, the variance is not
straightforward, but Särndal et al. show that it can be written as</p>
<p><span class="math display">\[\begin{equation}
\tag{2} \label{eq:eq2}
V(\hat{T}_{TP}) = \sum_{i=1}^N\sum_{j=1}^N \text{Cov}(R_{ai},
R_{aj})\frac{y_i}{\pi_{a_i}} \frac{y_j}{\pi_{aj}} +
\mathbb{E}\left[\sum_{i \in I_{s_a}}\sum_{j \in I_{s_a}} \text{Cov}(R_i,
R_j|S_a) \frac{y_i}{\pi_{ai}\pi_{i|s_a}}\frac{y_j}{\pi_{aj}\pi_{j|s_a}}
\right],
\end{equation}\]</span></p>
<p>where <span class="math inline">\(R_{ai}\)</span> and <span class="math inline">\(R_{aj}\)</span> are the phase 1 sample inclusion
indicators for elements <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>, and <span class="math inline">\(R_{i}\)</span> and <span class="math inline">\(R_{j}\)</span> are phase 2 sample inclusion
indicators. The expectation in the second term is with respect to the
phase 1 design. This variance is estimated unbiasedly by</p>
<p><span class="math display">\[\begin{equation}
\tag{3} \label{eq:eq3}
\hat{V}(\hat{T}_{TP}) = \sum_{i \in I_{s_a}}\sum_{j \in I_{s_a}}
R_{i}R_{j} \frac{\text{Cov}(R_{ai},
R_{aj})}{\pi_{aij}\pi_{ij|s_a}}\frac{y_i}{\pi_{a_i}}
\frac{y_j}{\pi_{aj}} + \sum_{i \in I_{s_a}}\sum_{j \in I_{s_a}}
R_{i}R_{j} \frac{\text{Cov}(R_i, R_j|S_a)}{\pi_{ij|s_a}}
\frac{y_i}{\pi_{ai}\pi_{i|s_a}}\frac{y_j}{\pi_{aj}\pi_{j|s_a}}.
\end{equation}\]</span></p>
<p>If phase 1 is a simple random sample and phase 2 is a stratified
random sample, then we have <span class="math display">\[
\hat{T}_{TP} = \sum_{k=1}^K\sum_{i \in
I_{k}}R_i\frac{N}{n_a}\frac{n_{ak}}{n_{k}}y_i =
\frac{N}{n_a}\sum_{k=1}^K\frac{n_{ak}}{n_{k}}\sum_{i \in I_k}R_iy_i,
\]</span></p>
<p>and</p>
<p><span class="math display">\[
V(\hat{T}_{TP}) = N^2\frac{1 -
\frac{n_a}{N}}{n_a}\text{Var}_\text{pop}(y) +
\mathbb{E}\left[N^2\sum_{k=1}^K
(\frac{n_{ak}}{n_a})^2\frac{1-\frac{n_k}{n_{ak}}}{n_k}\text{Var}_{s_{ak}}(y)
\right],
\]</span> where <span class="math inline">\(\text{Var}_\text{pop}(y)\)</span> is the variance
of <span class="math inline">\(y\)</span> in the population and <span class="math inline">\(\text{Var}_{s_{ak}}(y)\)</span> is the variance in
stratum <span class="math inline">\(k\)</span> of the phase 1 sample.
This variance is estimated unbiasedly by</p>
<p><span class="math display">\[\begin{equation}
\tag{4} \label{eq:eq4}
\hat{V}(\hat{T}_{TP}) = N(N-1)\sum_{k=1}^K\left(\frac{n_{ak}-1}{n_a-1} -
\frac{n_k - 1}{N-1}\right)\frac{n_{ak}S^2_{y,s_k}}{n_a n_k} + \\
\frac{N(N-n_a)}{n_a-1}\sum_{k=1}^K
\frac{n_{ak}}{n_a}\left(\frac{1}{n_k}\sum_{i=1}^{n_k}R_iy_i -
\frac{1}{N}\sum_{k=1}^K\sum_{i \in
I_k}R_i\frac{N}{n_a}\frac{n_{ak}}{n_{k}}y_i\right)^2,
\end{equation}\]</span> where <span class="math inline">\(S^2_{y,s_k}\)</span> is the phase 2 sample
variance of <span class="math inline">\(y\)</span> in stratum <span class="math inline">\(k\)</span>. The <code>twophase()</code> function
in the <code>survey</code> package uses (<span class="math inline">\(\ref{eq:eq3}\)</span>) to calculate the variance
for method <code>"full"</code> and (<span class="math inline">\(\ref{eq:eq4}\)</span>) for method
<code>"approx"</code> or <code>"simple"</code>.</p>
</div>
<div class="section level4">
<h4 id="two-phase-multi-wave-sampling">Two-phase, multi-wave sampling<a class="anchor" aria-label="anchor" href="#two-phase-multi-wave-sampling"></a>
</h4>
<p>The efficiency gains from collecting auxilary information in phase 1
can be improved even further by breaking phase 2 into waves and updating
the sampling design after each wave. Consider collecting <span class="math inline">\(n\)</span> samples across <span class="math inline">\(T\)</span> waves, where the sample size in the
<span class="math inline">\(t\)</span>-th wave (<span class="math inline">\(t = 1, ...,T\)</span>) is denoted <span class="math inline">\(n_t\)</span>. This approach presents a similar
challenge to the multi-phase setting, as the results of wave <span class="math inline">\(t\)</span> influence the allocation, and therefore
the sampling probabilities, for waves <span class="math inline">\(t^*
&gt; t\)</span>.</p>
<p>Broadly, a two-phase, multi-wave sampling design consists of the
following steps:</p>
<ol style="list-style-type: decimal">
<li>Phase 1: Draw a <span class="math inline">\(n_a\)</span> samples
from the population in Phase 1 according to a SRS (or other)
design.</li>
<li>Construct strata (indexed with <span class="math inline">\(h = 1,
..., H\)</span>) based on information gathered in Phase 1.</li>
<li>Phase 2, Wave 1: Allocate samples to strata according to optimum
allocation determined using estimates of optimality parameters from
phase 1 data.</li>
<li>Phase 2, Wave 2: Allocate samples to strata according to optimum
allocation determined using estimates of optimality parameters from
phase 2, wave 1 data.<br>
⋮<br>
Phase 2, Wave T: Allocate samples to strata according to optimum
allocation determined using estimates of optimality parameters from data
collected in prior waves of phase 2.</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="estimation-approaches-after-two-phase-multi-wave-sampling">Estimation approaches after two-phase, multi-wave sampling<a class="anchor" aria-label="anchor" href="#estimation-approaches-after-two-phase-multi-wave-sampling"></a>
</h2>
<p>Here, we present three potential estimators for a population total
under two-phase, multi-wave sampling.</p>
<div class="section level4">
<h4 id="post-stratification">1. Post-stratification<a class="anchor" aria-label="anchor" href="#post-stratification"></a>
</h4>
<p>The examples contained in the <code>optimall</code> package vignettes
use post-stratification weights to conduct estimation. As discussed by
Holt and Smith (1979), Valliant (1993) and Lumley, Shaw, and Dai (2011),
post-stratification is a robust and efficient estimation method that
assigns weights to sample elements based on strata constructed after the
sample has been collected rather than relying on pre-specified sampling
probabilities as traditional IPW estimators do. This approach is useful
in the multi-wave sampling setting because it does not require
computation of exact, or even wave-conditional, inclusion probabilities
(nor does variance estimation involve their pairwise inclusion
probabilities). Instead, the post-stratification approach assigns the
same weight to every member of stratum <span class="math inline">\(k\)</span>, <span class="math inline">\(\frac{N_k}{n_k} = \frac{N_k}{\sum_{t=1}^T
n_{tk}}\)</span>, where <span class="math inline">\(n_{tk}\)</span> is
the number of samples selected from stratum <span class="math inline">\(k\)</span> at wave <span class="math inline">\(t\)</span>. This weight is the inverse of the
final sampling fractions, and it reflects what the exact IPW weights
would be if the final allocation was obtained in a single wave. The
final estimator is simple to calculate and takes the form</p>
<p><span class="math display">\[
\hat{T}_{POST} = \sum_{k=1}^K\sum_{i \in I_k}R_i\frac{N_k}{n_k}y_i,
\]</span></p>
<p>Conveniently, post-stratification can be viewed as a simple case of
generalized raking. Thus, Neyman and Wright allocations are still
approximately optimal (Chen and Lumley 2022).</p>
<!-- Consider a survey with three waves. If sampling at each wave were independent and stratified, the probability of individual $i$ being included in the sample would be

$$
\begin{align*}
P(i \in I_s) &= P(i \in I_1 \cup i \in I_2 \cup i \in I_3)\\
 &=
P(i \in I_{1}) + P(i \notin I_{1})\cdot P(i \in I_2) + P(i \notin I_1 \cap i \notin I_2) \cdot P(i \in I_3),
\end{align*}
$$ 

where $I_S$ is the set of indices for the entire phase 2 sample and $I_t$ is the set of indices sampled at wave $t$. Let $n_{tk}$ be the number of samples selected from stratum $k$ at wave $t$. Then we have

$$
\begin{align*}
P(i \in I_{s}) &= P(i \in I_k) \quad \text{(for }i\text{ in stratum }k{)} \\
&= \frac{n_{1k}}{N_{k}} + \left(1 - \frac{n_{1k}}{N_k}\right)\cdot \frac{n_{2k}}{N_k-n_{1k}} + \left(1 - \left(1 - \frac{n_{1k}}{N_k}\right)\cdot \frac{n_{2k}}{N_k-n_{1k}}\right)\cdot \frac{n_{3k}}{N_k-n_{1k} - n_{2k}}\\
&= \frac{n_{1k}}{N_{k}} +\frac{n_{2k}}{N_k} + \frac{n_{3k}}{N_k} = \frac{n_{1k}+n_{2k}+ n_{3k}}{N_k},\\
\end{align*}
$$
and so the weight $\frac{1}{\pi_i}$ would be $\frac{N_k}{n_{1k}+n_{2k}+ n_{3k}}$ exactly the post-stratification weight. 
-->
</div>
<div class="section level4">
<h4 id="wave-specific-conditional-probabilties">2. Wave-specific conditional probabilties<a class="anchor" aria-label="anchor" href="#wave-specific-conditional-probabilties"></a>
</h4>
<p>Consider the unbiased two-phase estimator for the population total in
(<span class="math inline">\(\ref{eq:eq1}\)</span>), which, when
stratified random sampling is used in Phase 2, can be written:</p>
<p><span class="math display">\[\begin{equation}
\tag{5} \label{eq:eq5}
\hat{T}_{TP} = \sum_{i \in I_{s_a}}\frac{1}{\pi_{ai}\pi_{i|s_a}}y_i  =
\sum_{k=1}^K \sum_{i \in I_{k, s_a}} \frac{1}{\pi_{ai}\pi_{k|s_a}}y_i,
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\pi_{k|s_a}\)</span> is the phase 2
sampling probability for observations in stratum <span class="math inline">\(k\)</span> conditional on the observed Phase 1,
and <span class="math inline">\(I_{k, s_a}\)</span> is the set of
indices for individuals sampled in <span class="math inline">\(s_a\)</span> in stratum <span class="math inline">\(k\)</span>. While <span class="math inline">\(\pi_{ai}\)</span> can be determined by the Phase 1
design, <span class="math inline">\(\pi_{\cdot|s_a}\)</span> becomes
more complex when Phase 2 is conducted over multiple waves, as the
result from each wave affects the sampling probabilities for subsequent
waves. A natural extension of (<span class="math inline">\(\ref{eq:eq5}\)</span>) is to continue conditioning
the probabilities at each wave. Now, however, an element can only be
sampled in a given wave if it was not sampled in any prior waves. For a
two-phase, multi-wave sample with <span class="math inline">\(T\)</span>
waves of stratified random sampling in phase 2, this would yield</p>
<p><span class="math display">\[\begin{equation}
\tag{6} \label{eq:eq6}
\hat{T}_{TP} = \sum_{k=1}^K\frac{1}{T_k}\sum_{t^* = 1}^{T}\sum_{i \in
I_{k,s_a, t^*}}\frac{1}{\pi_{ai}(1-\pi_{k1|s_a})(1-\pi_{k2|s_a,
s_{b_1}}) \cdots (1-\pi_{k(t^*-1)|s_a, s_{b1},...,
s_{b(t^*-2)}})\pi_{kt^*|s_a, s_{b_1}, ..., s_{b_{t^*-1}}}}y_i,
\end{equation}\]</span></p>
<p>where <span class="math inline">\(I_{k, s_a,t^*}\)</span> is now the
set of sample indices for elements in stratum <span class="math inline">\(k\)</span> that were sampled in <span class="math inline">\(s_a\)</span> and in wave <span class="math inline">\(t^*\)</span> of Phase 2. <span class="math inline">\(\pi_{kt|s_a, s_{b_1}, ..., s_{b_{t-1}}}\)</span>
is the probability that a member of stratum <span class="math inline">\(k\)</span> is sampled in phase 2, wave t,
conditional on the observed waves <span class="math inline">\(b_1\)</span> through <span class="math inline">\(b_{t-1}\)</span>. <span class="math inline">\(T_k\)</span> is the number of waves in which
stratum <span class="math inline">\(k\)</span> had a non-zero sampling
probability, and is assumed to be <span class="math inline">\(&gt;0\)</span>. For simplicity, now denote for the
denominator of (Equation <span class="math inline">\(\ref{eq:eq6}\)</span>) <span class="math inline">\(\tilde{\pi_i} :=
\pi_{ai}(1-\pi_{k1|s_a})(1-\pi_{k2|s_a, s_{b_1}}) \cdots
(1-\pi_{k(t^*-1)|s_a, s_{b1},..., s_{b(t^*-2)}})\pi_{kt^*|s_a, s_{b_1},
..., s_{b_{t^*-1}}}\)</span></p>
<p>While this estimator is unbiased for the true population total, it
has a larger variance than the post-stratified estimator. Further,
estimating standard errors is even more complicated than in the
traditional two-phase case (<span class="math inline">\(\ref{eq:eq2}\)</span>) because each wave
contributes to the variance. A variance estimator for <span class="math inline">\(\hat{T}_{TP}\)</span> under stratified random
sampling without replacement in Phase 2 follows the form of (Equation
<span class="math inline">\(\ref{eq:eq3}\)</span>) with (assuming for
simplicity that <span class="math inline">\(T_k = T\)</span> <span class="math inline">\(\forall\)</span> <span class="math inline">\(k\)</span>):</p>
<p><span class="math display">\[\begin{equation}
\tag{7} \label{eq:eq7}
\hat{V}\left(\hat{T}_{TP}\right)= \underbrace{\sum_{i \in
I_{s_a}}\sum_{j \in I_{s_a}}  \frac{\text{Cov}(R_{ai},
R_{aj})}{\pi_{aij}\pi_{ij|s_a}}\frac{y_i}{\pi_{ai}}
\frac{y_j}{\pi_{aj}}}_{\text{Phase 1 contribution, same as (Eq. 3)}} \\
+
\frac{1}{T^2}\sum_{k=1}^K \sum_{t^*=1}^T\sum_{i, j \in{k,s_a,
t^*}}\left(1 - \frac{\tilde{\pi_i}\tilde{\pi_j}}{\frac{n_{kt^*}}{n_{ak}
- \sum_{t''&lt;t^*}n_{kt''}}\prod_{t' &lt;
t^*}(1-\frac{n_{kt'}}{n_{ak} -
\sum_{t''&lt;t'}n_{kt''}})(1-\frac{n_{kt'}}{n_{ak}
-
\sum_{t''&lt;t'}n_{kt''}-1})}\right)\frac{y_i}{\tilde{\pi_i}}\frac{y_j}{\tilde{\pi_j}}
\end{equation}\]</span></p>
<p>The following section demonstrates how to compute this estimator in
<code>R</code>using <code>optimall</code> and <code>survey</code>. In
the simulations at the end of this vignette, we demonstrate its
performance against post-stratification.</p>
</div>
</div>
<div class="section level2">
<h2 id="how-to-implement-each-strategy-with-optimall-and-survey">How to implement each strategy with <code>optimall</code> and
<code>survey</code><a class="anchor" aria-label="anchor" href="#how-to-implement-each-strategy-with-optimall-and-survey"></a>
</h2>
<p>In this section we demonstrate how to estimate a population mean
using the three estimators defined in the previous section with
<code>optimall</code> and <code>survey</code>. For this example, we
simulate a phase 1 dataset with n = 1,000 observations modelled after
the <code>iris</code> dataset (see appendix). The dataset contains
information on three species, which we use as strata, assuming phase 1
is drawn as a simple random sample from a superpopulation. Sepal Length
and Species are available at phase 1, and Petal Length is the variable
of interest available at phase 2. We conduct phase 2 sampling over three
waves using <code>optimall</code>, collecting Petal Length for 50
samples at each wave. The final dataset looks like:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">survey_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;    id Species Sepal.Length Petal.Length sampled_phase2 sampled_wave2.1</span></span>
<span><span class="co">#&gt; 22 22  setosa     2.278977    0.6026001              1               1</span></span>
<span><span class="co">#&gt; 50 50  setosa     4.088162    1.1976046              1               0</span></span>
<span><span class="co">#&gt; 67 67  setosa     4.841755    1.5282054              1               0</span></span>
<span><span class="co">#&gt; 71 71  setosa     5.739395    1.7258338              1               1</span></span>
<span><span class="co">#&gt; 73 73  setosa     3.669596    0.9204304              1               0</span></span>
<span><span class="co">#&gt; 77 77  setosa     5.194793    1.4941155              1               1</span></span>
<span><span class="co">#&gt;    sampled_wave2.2 sampled_wave2.3 sampling_prob wave</span></span>
<span><span class="co">#&gt; 22               0               0    0.07485030    1</span></span>
<span><span class="co">#&gt; 50               0               1    0.05501618    3</span></span>
<span><span class="co">#&gt; 67               0               1    0.05501618    3</span></span>
<span><span class="co">#&gt; 71               0               0    0.07485030    1</span></span>
<span><span class="co">#&gt; 73               0               1    0.05501618    3</span></span>
<span><span class="co">#&gt; 77               0               0    0.07485030    1</span></span></code></pre></div>
<p>The code to conduct multi-wave sampling and generate this data frame
using <code>optimall</code> is provided in the appendix.</p>
<div class="section level4">
<h4 id="post-stratification-1">1. Post-stratification<a class="anchor" aria-label="anchor" href="#post-stratification-1"></a>
</h4>
<p>Post-stratification is straightforward to implement with the
<code>twophase</code> function in <code>survey</code>. We start by
initializing the two-phase design.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pst_design</span> <span class="op">&lt;-</span> <span class="fu">twophase</span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">~</span><span class="va">id</span>, <span class="op">~</span><span class="va">id</span><span class="op">)</span>, strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="op">~</span><span class="va">Species</span><span class="op">)</span>,</span>
<span>                       subset <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">sampled_phase2</span><span class="op">)</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">survey_data</span>, method <span class="op">=</span> <span class="st">"simple"</span><span class="op">)</span></span></code></pre></div>
<p>Note that here we use <code>method = "simple</code> because phase 1
was a simple random sample and phase 2 was a stratified random sample.
Because we specified Species as the phase 2 stratification variable, we
can calculate the post-stratified estimate directly using
<code>svymean()</code> in the Survey package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pst_est</span> <span class="op">&lt;-</span> <span class="fu">svymean</span><span class="op">(</span><span class="op">~</span><span class="va">Petal.Length</span>, design <span class="op">=</span> <span class="va">pst_design</span><span class="op">)</span></span>
<span><span class="va">pst_est</span></span>
<span><span class="co">#&gt;                mean     SE</span></span>
<span><span class="co">#&gt; Petal.Length 3.7233 0.0708</span></span></code></pre></div>
<p>Note that another option would be to use the <code>calibrate()</code>
function to perform post-stratification using Species as the
stratification variable. See the “Two phase” vignette in the
<code>survey</code> package for more information.</p>
<div class="section level5">
<h5 id="post-stratification-with-raking">Post-stratification with raking<a class="anchor" aria-label="anchor" href="#post-stratification-with-raking"></a>
</h5>
<p>To obtain an even more efficient estimator, we can rake on both the
Sepal.Length and stratification variable. This is also straightforward
to implement with the <code>survey</code> package.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pst_design_rake</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">pst_design</span>, <span class="op">~</span><span class="va">Sepal.Length</span> <span class="op">+</span> <span class="va">Species</span>,</span>
<span>                             phase <span class="op">=</span> <span class="fl">2</span>, calfun <span class="op">=</span> <span class="st">"raking"</span><span class="op">)</span></span>
<span><span class="va">pst_est_rake</span> <span class="op">&lt;-</span> <span class="fu">svymean</span><span class="op">(</span><span class="op">~</span><span class="va">Petal.Length</span>, design <span class="op">=</span> <span class="va">pst_design_rake</span><span class="op">)</span></span>
<span><span class="va">pst_est_rake</span></span>
<span><span class="co">#&gt;               mean     SE</span></span>
<span><span class="co">#&gt; Petal.Length 3.764 0.0635</span></span></code></pre></div>
</div>
</div>
<div class="section level4">
<h4 id="wave-specific-conditional-probabilities">2. Wave-specific conditional probabilities<a class="anchor" aria-label="anchor" href="#wave-specific-conditional-probabilities"></a>
</h4>
<p>The wave-specific conditional probabilities approach is more
complicated because it requires computation of the denominator of (<span class="math inline">\(\ref{eq:eq6}\)</span>), and variance estimation
involves pairwise element inclusion probabilities of (<span class="math inline">\(\ref{eq:eq7}\)</span>). Still, it is possible to
obtain estimates and asymptotic standard errors through this approach
with <code>optimall</code> and <code>Survey</code>.</p>
<!--
  As of `survey` package version 4.4-2, the `twophase()` function accepts a matrix of pairwise sampling probabilities through the `pps` argument. (\ref{eq:eq3}) requires these pairwise sampling probabilities, and `twophase()` cannot calculate them on its own because they depend on both the stratum that an element belongs to and the wave in which it was sampled. Elements sampled in different waves or belonging to different strata have independent sampling probabilities, so their pairwise probability is simply the product of their individual inclusion probabilities, but elements from the same stratum and sampled in the same wave have correlated sampling probabilities. 
-->
<p>We can compute the denominator of (<span class="math inline">\(\ref{eq:eq6}\)</span>) with:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Find denominator from eq. 6 for each wave, species</span></span>
<span><span class="va">denom_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Species</span>, <span class="va">wave</span>, <span class="va">sampling_prob</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">wave</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">Species</span>, <span class="va">wave</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">Species</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>denom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">wave</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">sampling_prob</span>, </span>
<span>                               <span class="va">sampling_prob</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumprod</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">sampling_prob</span>, default <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Merge back with original dataframe, attaching the denominator to each obs.</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">denom_data</span>, <span class="va">Species</span>, <span class="va">wave</span>, <span class="va">denom</span><span class="op">)</span>, </span>
<span>                   by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Species"</span>,<span class="st">"wave"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can then compute the estimate for the sample mean with
<code>twophase()</code> as long every stratum was sampled in every
wave:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cp_design</span> <span class="op">&lt;-</span> <span class="fu">twophase</span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">~</span><span class="va">id</span>, <span class="op">~</span><span class="va">id</span><span class="op">)</span>, strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="op">~</span><span class="va">Species</span><span class="op">)</span>,</span>
<span>                      subset <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">sampled_phase2</span><span class="op">)</span>,</span>
<span>                      data <span class="op">=</span> <span class="va">survey_data</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="op">~</span><span class="va">denom</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cp_est</span> <span class="op">&lt;-</span> <span class="fu">svymean</span><span class="op">(</span><span class="op">~</span><span class="va">Petal.Length</span>, design <span class="op">=</span> <span class="va">cp_design</span><span class="op">)</span></span>
<span><span class="va">cp_est</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt; Petal.Length </span></span>
<span><span class="co">#&gt;     3.999145</span></span></code></pre></div>
<p>If some strata were not sampled in any wave, we can still compute the
estimator for the mean (Equation <span class="math inline">\(\ref{eq:eq6}\)</span>) by hand:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phase2_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span><span class="op">[</span><span class="va">survey_data</span><span class="op">$</span><span class="va">sampled_phase2</span> <span class="op">==</span> <span class="fl">1</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># Weight observations by denominator from equation 6</span></span>
<span><span class="va">phase2_data</span><span class="op">$</span><span class="va">weighted_obs</span> <span class="op">&lt;-</span> <span class="va">phase2_data</span><span class="op">$</span><span class="va">Petal.Length</span><span class="op">/</span><span class="va">phase2_data</span><span class="op">$</span><span class="va">denom</span></span>
<span></span>
<span><span class="co"># Determine number of waves each stratum was sampled in  </span></span>
<span><span class="va">sampled_waves</span> <span class="op">&lt;-</span> <span class="va">denom_data</span><span class="op">[</span><span class="va">denom_data</span><span class="op">$</span><span class="va">sampling_prob</span> <span class="op">&gt;</span> <span class="fl">0</span>,<span class="op">]</span></span>
<span><span class="va">n_waves_sampled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">sampled_waves</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute estimate for total in equation 6</span></span>
<span><span class="va">total_est</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">phase2_data</span><span class="op">[</span><span class="va">phase2_data</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span>,</span>
<span>                              <span class="st">"weighted_obs"</span><span class="op">]</span><span class="op">)</span><span class="op">/</span> <span class="va">n_waves_sampled</span><span class="op">[</span><span class="st">"setosa"</span><span class="op">]</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">phase2_data</span><span class="op">[</span><span class="va">phase2_data</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"virginica"</span>,</span>
<span>                                <span class="st">"weighted_obs"</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="va">n_waves_sampled</span><span class="op">[</span><span class="st">"virginica"</span><span class="op">]</span><span class="op">+</span></span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">phase2_data</span><span class="op">[</span><span class="va">phase2_data</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"versicolor"</span>,</span>
<span>                                <span class="st">"weighted_obs"</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="va">n_waves_sampled</span><span class="op">[</span><span class="st">"versicolor"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">total_est</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Petal.Length"</span></span>
<span></span>
<span><span class="co"># Finally, compute the mean</span></span>
<span><span class="va">cp_est</span> <span class="op">&lt;-</span> <span class="va">total_est</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">survey_data</span><span class="op">)</span> </span>
<span><span class="va">cp_est</span> <span class="co"># this matches svymean() output above if all strata sampled in all waves</span></span>
<span><span class="co">#&gt; Petal.Length </span></span>
<span><span class="co">#&gt;     3.709761</span></span></code></pre></div>
<p>Finally, we can estimate standard error by directly evaluating
Equation (<span class="math inline">\(\ref{eq:eq7}\)</span>).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Combine design dataframes for waves 1-3. </span></span>
<span><span class="va">design_all_waves</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>phase2_wave <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                           <span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">Survey</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="st">"design"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>phase2_wave <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                           <span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">Survey</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="st">"design"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>phase2_wave <span class="op">=</span> <span class="fl">3</span>, </span>
<span>                                           <span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">Survey</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="st">"design"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n_to_sample <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">n_to_sample</span>, <span class="va">stratum_size</span><span class="op">)</span>,</span>
<span>                nsample_prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">nsample_prior</span><span class="op">)</span>, </span>
<span>                                       <span class="fl">0</span> , <span class="va">nsample_prior</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">###</span></span>
<span><span class="co">### Now add three columns to design: prob of two obs being sampled in a given</span></span>
<span><span class="co">### wave, prob of neither being sampled in given wave, or prob of only (specific) </span></span>
<span><span class="co">### one being sampled in given wave</span></span>
<span><span class="va">design_all_waves</span> <span class="op">&lt;-</span> <span class="va">design_all_waves</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>both_pp <span class="op">=</span> <span class="va">n_to_sample</span><span class="op">/</span><span class="op">(</span><span class="va">npop</span> <span class="op">-</span> <span class="va">nsample_prior</span><span class="op">)</span><span class="op">*</span></span>
<span>                  <span class="op">(</span><span class="va">n_to_sample</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">npop</span> <span class="op">-</span> <span class="va">nsample_prior</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="co">#n/N*(n-1)/(N-1)</span></span>
<span>                onlyone_pp <span class="op">=</span> <span class="va">n_to_sample</span><span class="op">/</span><span class="op">(</span><span class="va">npop</span> <span class="op">-</span> <span class="va">nsample_prior</span><span class="op">)</span><span class="op">*</span></span>
<span>                  <span class="op">(</span><span class="va">npop</span><span class="op">-</span> <span class="va">nsample_prior</span><span class="op">-</span> <span class="va">n_to_sample</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">npop</span> <span class="op">-</span> <span class="va">nsample_prior</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                neither_pp <span class="op">=</span> </span>
<span>                  <span class="op">(</span><span class="va">npop</span><span class="op">-</span> <span class="va">nsample_prior</span><span class="op">-</span> <span class="va">n_to_sample</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">npop</span> <span class="op">-</span> <span class="va">nsample_prior</span><span class="op">)</span><span class="op">*</span></span>
<span>                  <span class="op">(</span><span class="va">npop</span><span class="op">-</span> <span class="va">nsample_prior</span><span class="op">-</span> <span class="va">n_to_sample</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">npop</span> <span class="op">-</span> <span class="va">nsample_prior</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                single_prob <span class="op">=</span> <span class="va">n_to_sample</span><span class="op">/</span><span class="op">(</span><span class="va">npop</span> <span class="op">-</span> <span class="va">nsample_prior</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">### One row for each stratum</span></span>
<span><span class="va">design_all_waves_wide</span> <span class="op">&lt;-</span> <span class="va">design_all_waves</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">phase2_wave</span>, <span class="va">strata</span>, <span class="va">both_pp</span>, <span class="va">onlyone_pp</span>, <span class="va">neither_pp</span>, <span class="va">single_prob</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">phase2_wave</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">both_pp</span>, <span class="va">onlyone_pp</span>,</span>
<span>                                                               <span class="va">neither_pp</span>, <span class="va">single_prob</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Compute pairwise probability of inclusion and variance contribution</span></span>
<span><span class="co">### for each pair of Phase 2 samples</span></span>
<span><span class="va">phase2_ids</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">survey_data</span>, <span class="va">sampled_phase2</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">id</span></span>
<span><span class="va">pairwise_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="st">"id1"</span> <span class="op">=</span> <span class="va">phase2_ids</span>, <span class="st">"id2"</span> <span class="op">=</span> <span class="va">phase2_ids</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">survey_data</span>, <span class="va">id</span>, <span class="st">"Species1"</span> <span class="op">=</span> <span class="va">Species</span>,</span>
<span>                                 <span class="st">"wave1"</span> <span class="op">=</span> <span class="va">wave</span>,</span>
<span>                                 <span class="st">"denom1"</span> <span class="op">=</span> <span class="va">denom</span>,</span>
<span>                                 <span class="st">"Petal.Length1"</span> <span class="op">=</span> <span class="va">Petal.Length</span><span class="op">)</span>,</span>
<span>                   by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id1"</span> <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">survey_data</span>, <span class="va">id</span>, <span class="st">"Species2"</span> <span class="op">=</span> <span class="va">Species</span>,</span>
<span>                                 <span class="st">"wave2"</span> <span class="op">=</span> <span class="va">wave</span>,</span>
<span>                                 <span class="st">"denom2"</span> <span class="op">=</span> <span class="va">denom</span>,</span>
<span>                                 <span class="st">"Petal.Length2"</span> <span class="op">=</span> <span class="va">Petal.Length</span><span class="op">)</span>,</span>
<span>                   by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id2"</span> <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">design_all_waves_wide</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Species1"</span> <span class="op">=</span> <span class="st">"strata"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pairwise_prob <span class="op">=</span></span>
<span>                  <span class="fu">case_when</span><span class="op">(</span><span class="va">id1</span> <span class="op">==</span> <span class="va">id2</span> <span class="op">~</span> <span class="va">denom1</span>,</span>
<span>                            <span class="va">Species1</span> <span class="op">!=</span> <span class="va">Species2</span> <span class="op">~</span> <span class="va">denom1</span><span class="op">*</span><span class="va">denom2</span>,</span>
<span>                            <span class="va">wave1</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">wave2</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">both_pp_1</span>,</span>
<span>                            <span class="va">wave1</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">wave2</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="va">neither_pp_1</span><span class="op">*</span><span class="va">both_pp_2</span>,</span>
<span>                            <span class="va">wave1</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">wave2</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="va">neither_pp_1</span><span class="op">*</span><span class="va">neither_pp_2</span><span class="op">*</span><span class="va">both_pp_3</span>,</span>
<span>                            <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">denom1</span><span class="op">*</span><span class="va">denom2</span><span class="op">)</span>,</span>
<span>                phase2_variance_contribution <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">denom1</span><span class="op">*</span><span class="va">denom2</span><span class="op">/</span><span class="va">pairwise_prob</span><span class="op">)</span><span class="op">*</span></span>
<span>                  <span class="va">Petal.Length1</span><span class="op">*</span><span class="va">Petal.Length2</span><span class="op">/</span><span class="op">(</span><span class="va">denom1</span><span class="op">*</span><span class="va">denom2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">phase2_variance_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pairwise_df</span><span class="op">$</span><span class="va">phase2_variance_contribution</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">phase1_data</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span><span class="co">##</span></span>
<span><span class="co">## Final variance estimator combines the phase 2 variance that we just calculated with</span></span>
<span><span class="co">## phase 1 variance (which was already calculated in post-stratified estimator)</span></span>
<span></span>
<span><span class="co">### Extract phase 1 variance estimate from pst_est</span></span>
<span><span class="va">phase1_variance_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu">SE</span><span class="op">(</span><span class="va">pst_est</span><span class="op">)</span>, <span class="st">"phases"</span><span class="op">)</span><span class="op">$</span><span class="va">phase1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co">### Estimate variance with two-phase()</span></span>
<span><span class="va">cp_est_ase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">phase2_variance_est</span> <span class="op">+</span> <span class="va">phase1_variance_est</span><span class="op">)</span></span>
<span><span class="va">cp_est_ase</span></span>
<span><span class="co">#&gt; [1] 0.07430421</span></span></code></pre></div>
<p>Rather than computing the variance entirely by hand as in the final
steps above, another option is to feed the pairwise sampling probability
matrix to <code>survey</code>. This will lead to the same answer.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pairwise_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">pairwise_df</span><span class="op">$</span><span class="va">pairwise_prob</span>,</span>
<span>                         ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">phase2_ids</span><span class="op">)</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">phase2_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span><span class="op">[</span><span class="va">survey_data</span><span class="op">$</span><span class="va">sampled_phase2</span> <span class="op">==</span> <span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="va">cp_design_phase2</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>id <span class="op">=</span> <span class="op">~</span><span class="va">id</span>,</span>
<span>                              data <span class="op">=</span> <span class="va">phase2_data</span>, probs <span class="op">=</span> <span class="op">~</span><span class="va">denom</span>,</span>
<span>                              pps <span class="op">=</span> <span class="fu">ppsmat</span><span class="op">(</span><span class="va">pairwise_probs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">phase2_variance_est</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu">SE</span><span class="op">(</span><span class="fu">svytotal</span><span class="op">(</span><span class="op">~</span><span class="va">Petal.Length</span>, design <span class="op">=</span> <span class="va">cp_design_phase2</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">phase1_data</span><span class="op">)</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span><span class="va">cp_est_ase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">phase2_variance_est</span> <span class="op">+</span> <span class="va">phase1_variance_est</span><span class="op">)</span></span>
<span><span class="va">cp_est_ase</span></span>
<span><span class="co">#&gt;            [,1]</span></span>
<span><span class="co">#&gt; [1,] 0.07430421</span></span></code></pre></div>
<p>The above computation of the Phase 2 variance Equation (<span class="math inline">\(\ref{eq:eq7}\)</span>) can be a bit arduous, but
when each stratum is sampled at least twice in each wave, the result is
closely approximated by only a few lines in the <code>survey</code>
package. This can be done by stratifying on both original strata and
sampling wave in a phase 2-specific call to <code>svydesign</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phase2_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span><span class="op">[</span><span class="va">survey_data</span><span class="op">$</span><span class="va">sampled_phase2</span> <span class="op">==</span> <span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="va">phase2_data</span><span class="op">$</span><span class="va">strata_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">phase2_data</span><span class="op">$</span><span class="va">Species</span>, <span class="st">"."</span>, <span class="va">phase2_data</span><span class="op">$</span><span class="va">wave</span><span class="op">)</span></span>
<span><span class="va">svydesign_phase2</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>data <span class="op">=</span> <span class="va">phase2_data</span>,</span>
<span>                              ids <span class="op">=</span> <span class="op">~</span><span class="va">id</span>,</span>
<span>                              strata <span class="op">=</span> <span class="op">~</span><span class="va">strata_int</span>,</span>
<span>                              probs <span class="op">=</span> <span class="op">~</span><span class="va">denom</span><span class="op">)</span></span>
<span></span>
<span><span class="va">estimate_approx</span> <span class="op">&lt;-</span> <span class="fu">svytotal</span><span class="op">(</span><span class="op">~</span><span class="va">Petal.Length</span>, <span class="va">svydesign_phase2</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">phase1_data</span><span class="op">)</span><span class="op">/</span><span class="fl">3</span></span>
<span><span class="va">estimate_approx</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt; Petal.Length </span></span>
<span><span class="co">#&gt;     3.553907</span></span>
<span><span class="va">variance_approx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">phase1_variance_est</span> <span class="op">+</span> <span class="op">(</span><span class="fu">SE</span><span class="op">(</span><span class="va">estimate_approx</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">phase1_data</span><span class="op">)</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">variance_approx</span></span>
<span><span class="co">#&gt;              Petal.Length</span></span>
<span><span class="co">#&gt; Petal.Length   0.07500754</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="comparing-estimation-methods-through-simulation">Comparing estimation methods through simulation<a class="anchor" aria-label="anchor" href="#comparing-estimation-methods-through-simulation"></a>
</h2>
<p>To compare the performance of these estimators, we perform two-phase,
multiwave sampling on repeatedly simulated phase 2 datasets of the same
form as the large <code>iris</code> dataset in the previous section. The
tables below show the results from each estimation strategy. Here we use
the abbreviations ASE: asymptotic standard error estimated with
<code>survey</code>, ESE: empirical standard error, RMSE: root mean
square error. Median over 2,000 simulations was reported for each point
estimate and ASE. The code to run these simulations is available on
Github <a href="https://github.com/yangjasp/optimall/blob/master/inst/simulations/poststrat_sims.R" class="external-link">here</a>.</p>
<p><strong>With n = 80 per wave:</strong></p>
<table class="table">
<colgroup>
<col width="41%">
<col width="11%">
<col width="10%">
<col width="11%">
<col width="8%">
<col width="8%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th>Case</th>
<th>True mean</th>
<th>Estimate</th>
<th>Coverage</th>
<th>ASE</th>
<th>ESE</th>
<th>RMSE</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Post-stratification</td>
<td>3.76</td>
<td>3.76</td>
<td>0.953</td>
<td>0.062</td>
<td>0.061</td>
<td>0.061</td>
</tr>
<tr class="even">
<td>Post-stratification w/ raking</td>
<td>3.76</td>
<td>3.76</td>
<td>0.957</td>
<td>0.060</td>
<td>0.059</td>
<td>0.059</td>
</tr>
<tr class="odd">
<td>Wave-specific probs. (eq. 6)</td>
<td>3.76</td>
<td>3.76</td>
<td>0.955</td>
<td>0.064</td>
<td>0.064</td>
<td>0.064</td>
</tr>
</tbody>
</table>
<p><strong>With n = 50 per wave:</strong></p>
<table class="table">
<colgroup>
<col width="41%">
<col width="11%">
<col width="10%">
<col width="11%">
<col width="8%">
<col width="8%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th>Case</th>
<th>True mean</th>
<th>Estimate</th>
<th>Coverage</th>
<th>ASE</th>
<th>ESE</th>
<th>RMSE</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Post-stratification</td>
<td>3.76</td>
<td>3.76</td>
<td>0.952</td>
<td>0.067</td>
<td>0.066</td>
<td>0.066</td>
</tr>
<tr class="even">
<td>Post-stratification w/ raking</td>
<td>3.76</td>
<td>3.76</td>
<td>0.952</td>
<td>0.063</td>
<td>0.062</td>
<td>0.062</td>
</tr>
<tr class="odd">
<td>Wave-specific probs. (eq. 6)</td>
<td>3.76</td>
<td>3.76</td>
<td>0.956</td>
<td>0.070</td>
<td>0.071</td>
<td>0.071</td>
</tr>
</tbody>
</table>
<p><strong>With n = 20 per wave:</strong></p>
<table class="table">
<colgroup>
<col width="41%">
<col width="11%">
<col width="10%">
<col width="10%">
<col width="8%">
<col width="8%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th>Case</th>
<th>True mean</th>
<th>Estimate</th>
<th>Coverage</th>
<th>ASE</th>
<th>ESE</th>
<th>RMSE</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Post-stratification</td>
<td>3.76</td>
<td>3.75</td>
<td>0.936</td>
<td>0.081</td>
<td>0.085</td>
<td>0.085</td>
</tr>
<tr class="even">
<td>Post-stratification w/ raking</td>
<td>3.76</td>
<td>3.76</td>
<td>0.941</td>
<td>0.072</td>
<td>0.075</td>
<td>0.075</td>
</tr>
<tr class="odd">
<td>Wave-specific probs. (eq. 6)</td>
<td>3.76</td>
<td>3.76</td>
<td>0.944</td>
<td>0.087</td>
<td>0.091</td>
<td>0.091</td>
</tr>
</tbody>
</table>
<p><!--
  Note on these variance estimates: As $n$ gets smaller, the post-stratified ase estimate starts to underestimate the ese more - see Sarndal 7.6 and (here)[https://www.sciencedirect.com/topics/mathematics/poststratification] for an idea about why - there is a second order term that makes true post-stratified variance larger that just a stratified random sampling estimate with the same strata. This happens because the groups/strata are also random. 

---></p>
<p>## References * Breslow, N. E., Lumley, T., Ballantyne, C. M.,
Chambless, L. E., &amp; Kulich, M. (2009). Improved Horvitz–Thompson
estimation of model parameters from two-phase stratified samples:
applications in epidemiology. Statistics in biosciences, 1, 32-49. *
Chen, T., &amp; Lumley, T. (2022). Optimal sampling for design‐based
estimators of regression models. Statistics in medicine, 41(8),
1482-1497. * Holt, D., &amp; Smith, T. F. (1979). Post stratification.
Journal of the Royal Statistical Society Series A: Statistics in
Society, 142(1), 33-46. * Lumley, T., Shaw, P. A., &amp; Dai, J. Y.
(2011). Connections between survey calibration estimators and
semiparametric models for incomplete data. International Statistical
Review, 79(2), 200-220. * McIsaac MA, Cook RJ. Adaptive sampling in
two‐phase designs: a biomarker study for progression in arthritis.
Statistics in Medicine. 2015 Sep 20;34(21):2899-912. * Särndal CE,
Swensson B, Wretman J (2003). Model Assisted Survey Sampling. Springer-
Verlag Science &amp; Business Media * Shepherd BE, Han K, Chen T, Bian
A, Pugh S, Duda S, Lumley T, Heerman WJ, Shaw PA (2023). “Multiwave
validation sampling for error-prone electronic health records.”
Biometrics, 79(3), 2649–2663. <a href="doi:10.1111/biom.13713" class="uri">doi:10.1111/biom.13713</a>. * Valliant R (1993).
“Poststratification and conditional variance estimation.” Journal of the
American Statistical Association, 88(421), 89–96. * Wright, T. A simple
method of exact optimal sample allocation under stratification with any
mixed constraint patterns.2014; Statistics, 07.</p>
</div>
<div class="section level2">
<h2 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<p>The code to generate the example <code>iris</code> dataset with
<code>optimall</code> is provided below:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#####</span></span>
<span><span class="co">## Generate data</span></span>
<span><span class="co">#####</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1000</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">col1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"setosa"</span>, times <span class="op">=</span> <span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"versicolor"</span>, times <span class="op">=</span> <span class="va">n</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"virginica"</span>, times <span class="op">=</span> <span class="va">n</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">1.462</span>, <span class="fl">0.432</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">4.260</span>, <span class="fl">0.470</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">5.552</span>, <span class="fl">0.552</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">pl</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="fl">3.35</span>, <span class="fl">0.341</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">pl</span><span class="op">[</span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">n</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="fl">1.32</span>, <span class="fl">0.366</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,  <span class="va">pl</span><span class="op">[</span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="fl">1000</span><span class="op">]</span> <span class="op">*</span> <span class="fl">1.14</span>, <span class="fl">0.302</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">full_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"id"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>,</span>
<span>                        <span class="st">"Species"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">col1</span><span class="op">)</span>,</span>
<span>                        <span class="st">"Sepal.Length"</span> <span class="op">=</span> <span class="va">sl</span>,</span>
<span>                        <span class="st">"Petal.Length"</span> <span class="op">=</span> <span class="va">pl</span><span class="op">)</span></span>
<span><span class="va">phase1_data</span> <span class="op">&lt;-</span> <span class="va">full_data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">4</span><span class="op">]</span></span>
<span></span>
<span><span class="co">####</span></span>
<span><span class="co">## Multiwave object setup</span></span>
<span><span class="co">####</span></span>
<span></span>
<span><span class="va">Survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiwave.html">multiwave</a></span><span class="op">(</span>phases <span class="op">=</span> <span class="fl">2</span>, waves <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>                    phase1 <span class="op">=</span> <span class="va">phase1_data</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">set_mw</span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, slot <span class="op">=</span> <span class="st">"metadata"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>                                                     strata <span class="op">=</span> <span class="st">"Species"</span>,</span>
<span>                                                     design_strata <span class="op">=</span> <span class="st">"strata"</span>,</span>
<span>                                                     include_probs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">####</span></span>
<span><span class="co">## Wave 1</span></span>
<span><span class="co">####</span></span>
<span></span>
<span><span class="co">### Allocation: X-allocate with Phase 1 sepal length</span></span>
<span><span class="va">Survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                          fun <span class="op">=</span> <span class="st">"optimum_allocation"</span>,</span>
<span>                          y <span class="op">=</span> <span class="st">"Sepal.Length"</span>,</span>
<span>                          nsample <span class="op">=</span> <span class="fl">50</span>, method <span class="op">=</span> <span class="st">"Neyman"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get_mw(Survey, phase = 2, wave = 1, slot ="design")</span></span>
<span></span>
<span><span class="co">### Select samples </span></span>
<span><span class="va">Survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                          fun <span class="op">=</span> <span class="st">"sample_strata"</span>, </span>
<span>                          n_allocated <span class="op">=</span> <span class="st">"stratum_size"</span>,</span>
<span>                          probs <span class="op">=</span> <span class="op">~</span><span class="va">stratum_size</span><span class="op">/</span><span class="va">npop</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### "Collect" data</span></span>
<span><span class="fu">set_mw</span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"sampled_data"</span><span class="op">)</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">full_data</span><span class="op">[</span><span class="va">full_data</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                     slot <span class="op">=</span> <span class="st">"samples"</span><span class="op">)</span><span class="op">$</span><span class="va">ids</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"Petal.Length"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">Survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_samples.html">merge_samples</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">####</span></span>
<span><span class="co">## Wave 2</span></span>
<span><span class="co">####</span></span>
<span></span>
<span><span class="co">### Allocation: Neyman allocation with already-collected phase 2 data.</span></span>
<span><span class="va">Survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                          fun <span class="op">=</span> <span class="st">"allocate_wave"</span>,</span>
<span>                          y <span class="op">=</span> <span class="st">"Petal.Length"</span>,</span>
<span>                          nsample <span class="op">=</span> <span class="fl">50</span>, allocation_method <span class="op">=</span> <span class="st">"Neyman"</span>,</span>
<span>                          already_sampled <span class="op">=</span> <span class="st">"sampled_phase2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get_mw(phase = 2, wave = 2, slot = "design")</span></span>
<span></span>
<span><span class="co">### Select samples </span></span>
<span><span class="va">Survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                          fun <span class="op">=</span> <span class="st">"sample_strata"</span>, </span>
<span>                          n_allocated <span class="op">=</span> <span class="st">"n_to_sample"</span>,</span>
<span>                          probs <span class="op">=</span> <span class="op">~</span><span class="va">n_to_sample</span><span class="op">/</span><span class="op">(</span><span class="va">npop</span> <span class="op">-</span> <span class="va">nsample_prior</span><span class="op">)</span>,</span>
<span>                          already_sampled <span class="op">=</span> <span class="st">"sampled_phase2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### "Collect" data</span></span>
<span><span class="fu">set_mw</span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">2</span>, slot <span class="op">=</span> <span class="st">"sampled_data"</span><span class="op">)</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">full_data</span><span class="op">[</span><span class="va">full_data</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                     slot <span class="op">=</span> <span class="st">"samples"</span><span class="op">)</span><span class="op">$</span><span class="va">ids</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"Petal.Length"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">Survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_samples.html">merge_samples</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">####</span></span>
<span><span class="co">## Wave 3</span></span>
<span><span class="co">####</span></span>
<span></span>
<span><span class="co">### Allocation: Neyman allocation with already-collected phase 2 data.</span></span>
<span><span class="va">Survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                          fun <span class="op">=</span> <span class="st">"allocate_wave"</span>,</span>
<span>                          y <span class="op">=</span> <span class="st">"Petal.Length"</span>,</span>
<span>                          nsample <span class="op">=</span> <span class="fl">50</span>, allocation_method <span class="op">=</span> <span class="st">"Neyman"</span>,</span>
<span>                          already_sampled <span class="op">=</span> <span class="st">"sampled_phase2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get_mw(phase = 2, wave = 3, slot = "design")</span></span>
<span></span>
<span><span class="co">### Select samples </span></span>
<span><span class="va">Survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                          fun <span class="op">=</span> <span class="st">"sample_strata"</span>, </span>
<span>                          n_allocated <span class="op">=</span> <span class="st">"n_to_sample"</span>,</span>
<span>                          probs <span class="op">=</span> <span class="op">~</span><span class="va">n_to_sample</span><span class="op">/</span><span class="op">(</span><span class="va">npop</span> <span class="op">-</span> <span class="va">nsample_prior</span><span class="op">)</span>,</span>
<span>                          already_sampled <span class="op">=</span> <span class="st">"sampled_phase2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### "Collect" data</span></span>
<span><span class="fu">set_mw</span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">3</span>, slot <span class="op">=</span> <span class="st">"sampled_data"</span><span class="op">)</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">full_data</span><span class="op">[</span><span class="va">full_data</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                     slot <span class="op">=</span> <span class="st">"samples"</span><span class="op">)</span><span class="op">$</span><span class="va">ids</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"Petal.Length"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">Survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_samples.html">merge_samples</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Final dataset for analysis</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">Survey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">3</span>, slot <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Clean up for printing</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"Species"</span>, <span class="st">"Sepal.Length"</span>, </span>
<span>                              <span class="st">"Petal.Length"</span>, <span class="st">"sampled_phase2"</span>,</span>
<span>                              <span class="st">"sampled_wave2.1"</span>, <span class="st">"sampled_wave2.2"</span>,</span>
<span>                              <span class="st">"sampled_wave2.3"</span>, <span class="st">"sampling_prob"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">survey_data</span><span class="op">$</span><span class="va">sampled_phase2</span>, </span>
<span>                                 <span class="va">survey_data</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">sampled_wave2.1</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                                 <span class="va">sampled_wave2.2</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>                                 <span class="va">sampled_wave2.3</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jasper Yang, Pamela Shaw.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
