<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="optimall">
<title>Multiwave Object • optimall</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Multiwave Object">
<meta property="og:description" content="optimall">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">optimall</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Multiwave-Estimation.html">Estimation in Two-phase, Multi-wave sampling</a>
    <a class="dropdown-item" href="../articles/Multiwave-Object.html">Multiwave Object</a>
    <a class="dropdown-item" href="../articles/optimall-vignette.html">Using Optimall</a>
    <a class="dropdown-item" href="../articles/using-optimall_shiny.html">Splitting Strata with Optimall Shiny</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/yangjasp/optimall/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Multiwave Object</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/yangjasp/optimall/blob/HEAD/vignettes/Multiwave-Object.Rmd" class="external-link"><code>vignettes/Multiwave-Object.Rmd</code></a></small>
      <div class="d-none name"><code>Multiwave-Object.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The base functions of <code>optimall</code> allow users to
efficiently determine optimum allocation, select samples, and split
strata during the design of a multi-wave stratified sampling survey.
Despite these features, an efficient sampling workflow in R still
requires the user to manually organize the many moving parts of the
process including design data, a list of samples, data extracted from
the samples, and merged data for each wave. When a sampling design
involves many waves, these parts can be difficult to keep track of and
may be prone to errors. Even more, it may be difficult to go back and
reproduce results at the end of a long sampling process.</p>
<p>This vignette describes an addition to <code>optimall</code> called
the multiwave object, which stores the metadata, design, samples, and
merged data from each step of the multi-wave sampling process in an
accessible format. It is optional for the user to use, but it offers the
advantages of automatic organization, efficient compatibility with other
functions in <code>optimall</code>, and an option for a summary of the
sampling design to be printed at any point. It is recommended that user
thoroughly reads the introductory package vignette titled “Using
Optimall” before reading this vignette.</p>
<p>This addition contributes towards <code>optimall's</code> goal of
being a tool to streamline the often cumbersome aspects of the
multi-wave sampling workflow.</p>
</div>
<div class="section level2">
<h2 id="format">Format<a class="anchor" aria-label="anchor" href="#format"></a>
</h2>
<p>The multiwave object uses the S4 class system, which makes it
slightly more complicated to work with in R. Fortunately, all of these
potential complications are dealt with in the package design and will be
unseen by the user. Here is what the user will see:</p>
<center>
<br><img src="../inst/images/MultiwaveStructure.png" style="width:65.0%">
</center>
<p><br></p>
<p>The multiwave object contains three S4 classes:</p>
<ul>
<li><p><strong>Wave:</strong> The Wave class (green in figure above)
holds the metadata, design, samples, sampled data, and data for a single
wave in multi-wave sampling.</p></li>
<li><p><strong>Phase:</strong> The Phase class (orange in figure above)
holds the metadata and a list of Wave objects for each phase.</p></li>
<li><p><strong>Multiwave:</strong> The Multiwave class (dark blue in
figure above) contains the metadata and a list of Phase objects. It
holds the entire sampling design and is the class that the user will
interact with the most.</p></li>
</ul>
<p>The light blue objects in the figure above represent the slots that
hold the survey information directly:</p>
<ul>
<li><p><strong>Metadata:</strong> The metadata slot holds an initially
empty list. Relevant information can be added as named elements,
including titles, data dictionaries, and arguments for
<code>optimall</code> functions.</p></li>
<li><p><strong>Design:</strong> The design slot holds the data frame
specifying the sampling design of the current wave. In order for it to
be used with <code><a href="../reference/sample_strata.html">sample_strata()</a></code>, it must contain at least one
column holding the strata names and one column holding the number of
samples to be selected from each strata. It is typically the output of
<code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code> or
<code><a href="../reference/allocate_wave.html">allocate_wave()</a></code>.</p></li>
<li>
<p><strong>Samples:</strong> The samples slot holds a list
containing :</p>
<ul>
<li>
<code>ids</code>: A vector of the sample ids that were selected in a
specific wave.</li>
<li>
<code>probs</code>: Optionally, a numeric vector of sampling
probabilities corresponding to each id in <code>ids</code>.</li>
</ul>
</li>
<li><p><strong>Sampled Data:</strong> The sampled data slot contains a
data frame holding the data collected in a specific wave.</p></li>
<li><p><strong>Data:</strong> The data slot contains a data frame with
the full data as it gets updated for each wave (or phase for phase 1).
It is typically the sampled data merged with the (full) data of the
previous wave. In this way, the data in the data slot of a study’s
ultimate sampling wave is the full study data that can be used for
analysis with the <code>survey</code> package.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="getting-started-with-the-multiwave-object">Getting Started with the Multiwave Object<a class="anchor" aria-label="anchor" href="#getting-started-with-the-multiwave-object"></a>
</h2>
<p>Working with the multiwave object only requires knowledge of a few
functions. This section describes how to initialize an object, how to
access and write slots of it, and how to deploy some of its useful
features. This will be demonstrated in the context of the same
two-phase, multiwave sampling design used in the package vignette.</p>
<p>A multiwave object is initialized by the function
<code><a href="../reference/multiwave.html">multiwave()</a></code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MySurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiwave.html">multiwave</a></span><span class="op">(</span>phases <span class="op">=</span> <span class="fl">2</span>, waves <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We now have an object that can hold all of the information for our
two-phase survey where the second phase will be conducted over three
waves. Note that the length of the ’waves‘ argument must match the
number of phases. Phase 1 will almost always have one wave.</p>
<div class="section level3">
<h3 id="access-and-write-slots">Access and Write slots<a class="anchor" aria-label="anchor" href="#access-and-write-slots"></a>
</h3>
<p>As is standard for an S4 object in R, components of the multiwave
object are stored in slots. To access and write slots of the multiwave
object, the user could use <code>@</code> and <code>$</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#To access overall metadata</span></span>
<span><span class="va">MySurvey</span><span class="op">@</span><span class="va">metadata</span></span>
<span><span class="co">#&gt; list()</span></span>
<span></span>
<span><span class="co">#To write overall metadata. We may want to include a title.</span></span>
<span><span class="va">MySurvey</span><span class="op">@</span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Maternal Weight Survey"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#To access Phase 2 metadata</span></span>
<span><span class="va">MySurvey</span><span class="op">@</span><span class="va">phases</span><span class="op">$</span><span class="va">phase2</span><span class="op">@</span><span class="va">metadata</span></span>
<span><span class="co">#&gt; list()</span></span>
<span></span>
<span><span class="co">#To access Phase 2, Wave 2 design</span></span>
<span><span class="va">MySurvey</span><span class="op">@</span><span class="va">phases</span><span class="op">$</span><span class="va">phase2</span><span class="op">@</span><span class="va">waves</span><span class="op">$</span><span class="va">wave2</span><span class="op">@</span><span class="va">design</span></span>
<span><span class="co">#&gt; data frame with 0 columns and 0 rows</span></span></code></pre></div>
<p>but this is overly complicated and potentially unstable. Instead, any
slot of the multiwave object can be accessed using the function
<code><a href="../reference/get_mw.html">get_mw()</a></code>, which only requires specification of the phase,
wave, and slot name:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#To access overall metadata</span></span>
<span><span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="cn">NA</span>, slot <span class="op">=</span> <span class="st">"metadata"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $title</span></span>
<span><span class="co">#&gt; [1] "Maternal Weight Survey"</span></span>
<span></span>
<span><span class="co">#To access Phase 2 metadata</span></span>
<span><span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, slot <span class="op">=</span> <span class="st">"metadata"</span><span class="op">)</span></span>
<span><span class="co">#&gt; list()</span></span>
<span></span>
<span><span class="co">#To access Phase 2, Wave 2 design</span></span>
<span><span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">2</span>, slot <span class="op">=</span> <span class="st">"design"</span><span class="op">)</span></span>
<span><span class="co">#&gt; data frame with 0 columns and 0 rows</span></span></code></pre></div>
<p>Similarly, any slot can written using <code>set_mw()</code>:</p>
<p>#To write overall metadata</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">set_mw</span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="cn">NA</span>, slot <span class="op">=</span> <span class="st">"metadata"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Maternal Weight Survey"</span><span class="op">)</span></span></code></pre></div>
<p>Note that calls to get data from phase 1 do not require
<code>wave</code> to be specified, since phase 1 only consists of one
wave.</p>
<p>Let’s suppose that our phase 1 data has been collected. We can add it
to the phase 1 data slot of our object and include any relevant
metadata:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">phase1</span><span class="op">)</span></span>
<span><span class="co">#&gt;                    new_strata old_strata   id mat_weight_est  race diabetes</span></span>
<span><span class="co">#&gt; 1  Black.MWC_est_(9.75,15.06]      Black 5586      12.176368 Black        0</span></span>
<span><span class="co">#&gt; 2  Black.MWC_est_(9.75,15.06]      Black 7322      11.774911 Black        0</span></span>
<span><span class="co">#&gt; 3  Black.MWC_est_(9.75,15.06]      Black 3602      10.649515 Black        0</span></span>
<span><span class="co">#&gt; 4  Black.MWC_est_(9.75,15.06]      Black 2734      12.026532 Black        0</span></span>
<span><span class="co">#&gt; 5 Black.MWC_est_(15.06,38.46]      Black  581      16.828686 Black        0</span></span>
<span><span class="co">#&gt; 6 Black.MWC_est_[-30.21,9.75]      Black 6531       9.163454 Black        1</span></span>
<span><span class="co">#&gt;   obesity</span></span>
<span><span class="co">#&gt; 1       0</span></span>
<span><span class="co">#&gt; 2       0</span></span>
<span><span class="co">#&gt; 3       0</span></span>
<span><span class="co">#&gt; 4       1</span></span>
<span><span class="co">#&gt; 5       0</span></span>
<span><span class="co">#&gt; 6       0</span></span>
<span></span>
<span><span class="fu">set_mw</span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">phase1</span></span>
<span></span>
<span><span class="co">#Make Phase 1 data dict</span></span>
<span><span class="va">phase1_data_dictionary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  <span class="st">"Variable"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"id"</span>, <span class="st">"race"</span>, <span class="st">"mat_weight_est"</span>, <span class="st">"diabetes"</span>, <span class="st">"obesity"</span><span class="op">)</span>,</span>
<span>  <span class="st">"Description"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"unique identifier"</span>, </span>
<span>                    <span class="st">"race of mother"</span>,</span>
<span>                    <span class="st">"error-prone estimate of maternal weight change </span></span>
<span><span class="st">                    during pregnancy"</span>,</span>
<span>                    <span class="st">"1/0 indicator for diabetes in the mother during </span></span>
<span><span class="st">                    pregnancy"</span>,</span>
<span>                    <span class="st">"1/0 indicator for childhood obesity in child"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">phase1_data_dictionary</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Variable</span></span>
<span><span class="co">#&gt; 1             id</span></span>
<span><span class="co">#&gt; 2           race</span></span>
<span><span class="co">#&gt; 3 mat_weight_est</span></span>
<span><span class="co">#&gt; 4       diabetes</span></span>
<span><span class="co">#&gt; 5        obesity</span></span>
<span><span class="co">#&gt;                                                                             Description</span></span>
<span><span class="co">#&gt; 1                                                                     unique identifier</span></span>
<span><span class="co">#&gt; 2                                                                        race of mother</span></span>
<span><span class="co">#&gt; 3 error-prone estimate of maternal weight change \n                    during pregnancy</span></span>
<span><span class="co">#&gt; 4       1/0 indicator for diabetes in the mother during \n                    pregnancy</span></span>
<span><span class="co">#&gt; 5                                          1/0 indicator for childhood obesity in child</span></span>
<span></span>
<span><span class="fu">set_mw</span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"metadata"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>data_dict <span class="op">=</span> <span class="va">phase1_data_dictionary</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="view-summary-diagram-of-survey">View Summary Diagram of Survey<a class="anchor" aria-label="anchor" href="#view-summary-diagram-of-survey"></a>
</h3>
<p>At any point during the multi-wave sampling workflow,
<code>optimall</code> allows users to view a diagram of the structure of
their survey with <code><a href="../reference/multiwave_diagram.html">multiwave_diagram()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/multiwave_diagram.html">multiwave_diagram</a></span><span class="op">(</span><span class="va">MySurvey</span><span class="op">)</span></span></code></pre></div>
<center>
<p><img src="../inst/images/Diagram1.png" style="width:55.0%"></p>
</center>
<p>Notice that the title of the survey, “Maternal Weight Survey”, was
found from the overall survey metadata and that boxes are colored based
on whether they have been filled yet. Slots that have been filled are
blue and contain a short description of their contents. This function
enables users to track their progress during a multiwave sampling
survey.</p>
</div>
<div class="section level3">
<h3 id="call-optimall-functions-with-fewer-arguments">Call <code>optimall</code> functions with fewer arguments<a class="anchor" aria-label="anchor" href="#call-optimall-functions-with-fewer-arguments"></a>
</h3>
<p>Another advantage of the multiwave object is that the primary
functions of <code>optimall</code> such as
<code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code>, <code><a href="../reference/allocate_wave.html">allocate_wave()</a></code>, and
<code><a href="../reference/sample_strata.html">sample_strata()</a></code> can be called on the object using the
function <code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code>, The
<code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code> function takes the standard arguments to
the function as well as <code>phase</code> and <code>wave</code>, which
are used to determine the input dataframe(s) and the slot of the object
where the output should be placed. If the arguments, including names of
columns (which tend to be repetitive when used without the multiwave
object framework), are specified in the metadata, the function will find
them itself, allowing calls to the function to be much simpler. It is
recommended that users gain familiarity with the basic uses of these
functions on dataframes before using them on multiwave objects.</p>
<p>When working with a multiwave object, a new function called
<code><a href="../reference/merge_samples.html">merge_samples()</a></code> also becomes available. This allows users
to quickly and efficiently merge the <code>sampled data</code> with the
previous wave’s <code>data</code>.</p>
<p>To demonstrate, we return to the example of sampling sepal width from
the iris dataset with an adaptive, multi-wave design. Suppose that we
have collected data on sepal length, petal width, and petal length for
all 150 iris plants in phase 1, but we have not yet collected any of the
”expensive” sepal width variable. We can start by placing the data in
the appropriate slot of our multiwave object:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Initialize Multiwave</span></span>
<span><span class="va">IrisSurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiwave.html">multiwave</a></span><span class="op">(</span>phases <span class="op">=</span> <span class="fl">2</span>, waves <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add id column to iris dataset</span></span>
<span><span class="va">iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html" class="external-link">iris</a></span>, id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">150</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># To place iris data in Phase 1</span></span>
<span><span class="fu">set_mw</span><span class="op">(</span><span class="va">IrisSurvey</span>, phase <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">iris</span>, select <span class="op">=</span> <span class="op">-</span><span class="va">Sepal.Width</span><span class="op">)</span></span></code></pre></div>
<p>Now we want to begin our first wave of sampling sepal width in phase
2. Since we expect that sepal length is correlated with our variable of
interest, we decide to x-allocate the first wave of samples using
integer-valued Neyman allocation on the inexpensive sepal length
variable. Since we are working in the multiwave object framework, we can
use <code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code> to apply the
<code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code> function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">IrisSurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">IrisSurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                            fun <span class="op">=</span> <span class="st">"optimum_allocation"</span>,</span>
<span>                            strata <span class="op">=</span> <span class="st">"Species"</span>, y <span class="op">=</span> <span class="st">"Sepal.Length"</span>,</span>
<span>                            nsample <span class="op">=</span> <span class="fl">30</span>, method <span class="op">=</span> <span class="st">"WrightII"</span><span class="op">)</span></span></code></pre></div>
<p>Since <code>"strata"</code> will be <code>"Species"</code> for every
wave, we may instead move that argument to the phase metadata so that we
don’t have to repetitively specify the same argument in every function
call:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">set_mw</span><span class="op">(</span><span class="va">IrisSurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, slot <span class="op">=</span> <span class="st">"metadata"</span><span class="op">)</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>strata <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span></span></code></pre></div>
<p>Now we no longer have to specify <code>strata</code> in the function
call:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">IrisSurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">IrisSurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                            fun <span class="op">=</span> <span class="st">"optimum_allocation"</span>,</span>
<span>                            y <span class="op">=</span> <span class="st">"Sepal.Length"</span>,</span>
<span>                            nsample <span class="op">=</span> <span class="fl">30</span>, method <span class="op">=</span> <span class="st">"WrightII"</span><span class="op">)</span></span></code></pre></div>
<p>In the absence of a specific strata argument, apply_multiwave() turns
to the wave, phase, and then overall metadata to look for the missing
argument. In this case, it finds <code>strata = "Species"</code> in the
phase metadata. By specifying the <code>phase</code> and
<code>wave</code> in the function call, we are telling
optimum_allocation() to use the most recent version of the data (the
full data from the previous wave, or in this case, the phase 1 data) as
input and to output the results in the corresponding slot of the
specified wave. As such, both calls to <code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code>
output an updated multiwave object with the results of
<code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code> in the phase 2, wave 1
<code>"design"</code> slot:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">IrisSurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"design"</span><span class="op">)</span></span>
<span><span class="co">#&gt;       strata npop   sd  n_sd stratum_fraction stratum_size</span></span>
<span><span class="co">#&gt; 1     setosa   50 0.35 17.62             0.23            7</span></span>
<span><span class="co">#&gt; 2 versicolor   50 0.52 25.81             0.33           10</span></span>
<span><span class="co">#&gt; 3  virginica   50 0.64 31.79             0.43           13</span></span></code></pre></div>
<p>The <code><a href="../reference/allocate_wave.html">allocate_wave()</a></code> function can be applied to multiwave
objects in the same manner and will be demonstrated in the following
examples section. After these functions have been used to specify a
”design” data frame (or a manually created design data frame has been
placed in the ”design” slot to implement a different allocation
strategy), we can use <code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code> to apply
<code><a href="../reference/sample_strata.html">sample_strata()</a></code> and select the ids to sample for the given
sampling wave:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">IrisSurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">IrisSurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                            fun <span class="op">=</span> <span class="st">"sample_strata"</span>, id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>                            design_strata <span class="op">=</span> <span class="st">"strata"</span>,</span>
<span>                            n_allocated <span class="op">=</span> <span class="st">"stratum_size"</span>,</span>
<span>                            probs <span class="op">=</span> <span class="st">"stratum_fraction"</span><span class="op">)</span></span></code></pre></div>
<p>Note that we did not have to specify the <code>data</code> or
<code>design_data</code> as we do in the standard version of
<code><a href="../reference/sample_strata.html">sample_strata()</a></code> because they are extracted from the
multiwave object using the <code>phase</code> and <code>wave</code>
arguments. We also did not have to specify the <code>strata</code>
argument again because it was available in the phase metadata. The
result of this call to <code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code> is an updated
<code>IrisSurvey</code> with a vector of ids to sample and their
inclusion probabilities in the “samples” slot:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">IrisSurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"samples"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $ids</span></span>
<span><span class="co">#&gt;  [1]  11  21  25  26  27  28  33  54  57  67  68  69  75  80  85  89  98 103 106</span></span>
<span><span class="co">#&gt; [20] 113 115 129 131 132 134 136 137 140 141 144</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $probs</span></span>
<span><span class="co">#&gt;  [1] 0.23 0.23 0.23 0.23 0.23 0.23 0.23 0.33 0.33 0.33 0.33 0.33 0.33 0.33 0.33</span></span>
<span><span class="co">#&gt; [16] 0.33 0.33 0.43 0.43 0.43 0.43 0.43 0.43 0.43 0.43 0.43 0.43 0.43 0.43 0.43</span></span></code></pre></div>
<p>When working with a multiwave object, a new function called
<code><a href="../reference/merge_samples.html">merge_samples()</a></code> also becomes available. This function
allows users to quickly and efficiently merge the sampled data with the
previous wave’s data. Suppose that we have collected the sepal width for
these 30 plant ids and placed the data in the “sampled_data” slot of
phase 2, wave 1 of <code>IrisSurvey</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">set_mw</span><span class="op">(</span><span class="va">IrisSurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"sampled_data"</span><span class="op">)</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">IrisSurvey</span>,</span>
<span>                             phase <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                             wave <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                             slot <span class="op">=</span> <span class="st">"samples"</span><span class="op">)</span><span class="op">$</span><span class="va">ids</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"Sepal.Width"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>We can call <code><a href="../reference/merge_samples.html">merge_samples()</a></code> to smoothly merge the
<code>sampled_data</code> of the current wave with the (full)
<code>data</code> from the previous wave and place the output in the
<code>data</code> slot of the current wave:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">IrisSurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_samples.html">merge_samples</a></span><span class="op">(</span><span class="va">IrisSurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                          id <span class="op">=</span> <span class="st">"id"</span>, include_probs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>In the <code>"data"</code> slot of phase 2, wave 1, we will now have
an updated dataframe with all of the phase 1 data and a sepal width
column that and has the sampled data for the selected ids and
<code>NA</code> values for the rest of the plants. There is also a new
column called <code>"sampled_phase2"</code> that holds an indicator for
which samples have been sampled in phase 2 thus far, a new column called
“sampled_wave2.1” that holds an indicator for which samples were sampled
in wave1 of phase 2, and a column of inclusion probabilities because we
specified <code>include_probs = TRUE</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">IrisSurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sepal.Length Petal.Length Petal.Width Species id Sepal.Width sampled_phase2</span></span>
<span><span class="co">#&gt; 1          5.1          1.4         0.2  setosa  1          NA              0</span></span>
<span><span class="co">#&gt; 2          4.9          1.4         0.2  setosa  2          NA              0</span></span>
<span><span class="co">#&gt; 3          4.7          1.3         0.2  setosa  3          NA              0</span></span>
<span><span class="co">#&gt; 4          4.6          1.5         0.2  setosa  4          NA              0</span></span>
<span><span class="co">#&gt; 5          5.0          1.4         0.2  setosa  5          NA              0</span></span>
<span><span class="co">#&gt; 6          5.4          1.7         0.4  setosa  6          NA              0</span></span>
<span><span class="co">#&gt;   sampled_wave2.1 sampling_prob</span></span>
<span><span class="co">#&gt; 1               0            NA</span></span>
<span><span class="co">#&gt; 2               0            NA</span></span>
<span><span class="co">#&gt; 3               0            NA</span></span>
<span><span class="co">#&gt; 4               0            NA</span></span>
<span><span class="co">#&gt; 5               0            NA</span></span>
<span><span class="co">#&gt; 6               0            NA</span></span></code></pre></div>
<p>Calls to <code><a href="../reference/merge_samples.html">merge_samples()</a></code> in later waves of phase 2 will
update the phase sampled indicator each time. The
<code>sample_strata</code> function will use this column to ensure that
units sampled in previous waves are not selected again. The utility of
<code><a href="../reference/merge_samples.html">merge_samples()</a></code> and <code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code> are
demonstrated further below.</p>
</div>
<div class="section level3">
<h3 id="example-wave-workflow-using-optimall-with-a-multiwave-object">Example Wave Workflow Using <code>optimall</code> with a Multiwave
Object<a class="anchor" aria-label="anchor" href="#example-wave-workflow-using-optimall-with-a-multiwave-object"></a>
</h3>
<p>In this section, we demonstrate an example of how the multiwave
object can be useful in the adaptive multi-wave sampling workflow. In
this example, we will create and execute Wave 1 of Phase 2 of our
sample.</p>
<p>The first step of Phase 2, Wave 1 is to specify the metadata for both
the phase and wave. Note that can be useful to specify a title,
description, function arguments, and anything else relevant to the
survey in the metadata, but nothing is <em>required</em> to be
specified. If no function arguments are found in the metadata, they must
instead be specified during the call to <code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code>.
In this example we choose to specify a description and function
arguments in the wave metadata:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Metadata for Phase 2 including description,</span></span>
<span><span class="co"># and column names to be used in function calls.</span></span>
<span><span class="co"># Note that each element name corresponds to at least one argument of a </span></span>
<span><span class="co"># function that will be called later on in the multi-wave workflow.</span></span>
<span><span class="fu">set_mw</span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, slot <span class="op">=</span> <span class="st">"metadata"</span><span class="op">)</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>description <span class="op">=</span> <span class="st">"Phase 2 of Maternal Weight Survey in which we</span></span>
<span><span class="st">       seek to validate 750 samples across three waves."</span>,</span>
<span>       strata <span class="op">=</span> <span class="st">"new_strata"</span>, <span class="co"># strata column in data (used in multiple funcs)</span></span>
<span>       id <span class="op">=</span> <span class="st">"id"</span>, <span class="co"># name of id column (used in sample_strata and merge_samples)</span></span>
<span>       y <span class="op">=</span> <span class="st">"mat_weight_true"</span>, <span class="co"># col for which to minimize variance </span></span>
<span>                                  <span class="co"># (used in optimum_allocation)</span></span>
<span>       design_strata <span class="op">=</span> <span class="st">"strata"</span>, <span class="co"># strata column in designs (used for sample_strata)</span></span>
<span>       n_allocated <span class="op">=</span> <span class="st">"n_to_sample"</span> <span class="co"># n allocated to strata in designs</span></span>
<span>                                    <span class="co"># (used for sample_strata)</span></span>
<span>       <span class="op">)</span></span>
<span></span>
<span><span class="co"># Then, metadata for Wave 1 of Phase 2 </span></span>
<span><span class="fu">set_mw</span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"metadata"</span><span class="op">)</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>description <span class="op">=</span> <span class="st">"First wave of 250 </span></span>
<span><span class="st">       sampled using proportional sampling"</span><span class="op">)</span></span></code></pre></div>
<p>After the metadata is specified, the next step is to specify the wave
1 survey design. We will allocate the first 250 samples using
x-allocation with the error-prone phase 1 maternal weight change
estimates as the design variable. The <code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code> and
<code><a href="../reference/optimum_allocation.html">optimum_allocation()</a></code> functions make this
straightforward:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Design for Wave 1</span></span>
<span><span class="va">MySurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                           fun <span class="op">=</span> <span class="st">"optimum_allocation"</span>,</span>
<span>                           strata <span class="op">=</span> <span class="st">"new_strata"</span>,</span>
<span>                           y <span class="op">=</span> <span class="st">"mat_weight_est"</span>,</span>
<span>                           nsample <span class="op">=</span> <span class="fl">250</span>, method <span class="op">=</span> <span class="st">"Neyman"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"design"</span><span class="op">)</span></span>
<span><span class="co">#&gt;                        strata npop   sd    n_sd stratum_fraction stratum_size</span></span>
<span><span class="co">#&gt; 1 Black.MWC_est_(15.06,38.46]  628 3.63 2277.53             0.09           23</span></span>
<span><span class="co">#&gt; 2  Black.MWC_est_(9.75,15.06] 1154 1.46 1688.46             0.07           17</span></span>
<span><span class="co">#&gt; 3 Black.MWC_est_[-30.21,9.75]  745 4.09 3050.57             0.12           31</span></span>
<span><span class="co">#&gt; 4 Other.MWC_est_(15.06,30.94]  325 2.41  781.93             0.03            8</span></span>
<span><span class="co">#&gt; 5  Other.MWC_est_(9.75,15.06]  929 1.44 1334.35             0.05           13</span></span>
<span><span class="co">#&gt; 6  Other.MWC_est_[-5.39,9.75]  456 2.46 1121.03             0.04           11</span></span>
<span><span class="co">#&gt; 7 White.MWC_est_(15.06,51.69] 1631 3.51 5726.61             0.23           57</span></span>
<span><span class="co">#&gt; 8  White.MWC_est_(9.75,15.06] 3084 1.44 4453.92             0.18           45</span></span>
<span><span class="co">#&gt; 9 White.MWC_est_[-25.68,9.75] 1383 3.24 4485.44             0.18           45</span></span></code></pre></div>
<p>We can use this design to randomly select ids to sample from the
previous wave (in this case the overall Phase 1 data) using
<code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code> to apply the function
<code><a href="../reference/sample_strata.html">sample_strata()</a></code> to the multiwave object. When applied to an
object of class “Multiwave”, <code><a href="../reference/sample_strata.html">sample_strata()</a></code> will find
<code>"data"</code> and <code>"design_data"</code> in the object and
will look in the wave, phase, then overall metadata for the other
arguments to <code><a href="../reference/sample_strata.html">sample_strata()</a></code> if they are not provided in
the call. It will return the same multiwave object with a vector of ids
to sample in the <code>"samples"</code> slot of the specified wave.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Get list of ids to sample using stratified random sampling </span></span>
<span><span class="co"># without replacement</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">MySurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                            fun <span class="op">=</span> <span class="st">"sample_strata"</span>,</span>
<span>                            strata <span class="op">=</span> <span class="st">"new_strata"</span>,</span>
<span>                            id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>                            wave2a <span class="op">=</span> <span class="cn">NULL</span>, <span class="co">#No one has been sampled yet</span></span>
<span>                            design_strata <span class="op">=</span> <span class="st">"strata"</span>, <span class="co">#from design</span></span>
<span>                            n_allocated <span class="op">=</span> <span class="st">"stratum_size"</span></span>
<span>                            <span class="op">)</span></span>
<span><span class="co"># check that it worked</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"samples"</span><span class="op">)</span><span class="op">$</span><span class="va">ids</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5702 3127 3267 3369 5449 3227</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"samples"</span><span class="op">)</span><span class="op">$</span><span class="va">ids</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 250</span></span>
<span></span>
<span><span class="co"># But, notice that we had already specified most of the arguments to </span></span>
<span><span class="co"># sample_strata in the phase metadata. So, we can get the same result</span></span>
<span><span class="co"># with a much shorter call to the function</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MySurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                            fun <span class="op">=</span> <span class="st">"sample_strata"</span>,</span>
<span>                            n_allocated <span class="op">=</span> <span class="st">"stratum_size"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ids_wave1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"samples"</span><span class="op">)</span><span class="op">$</span><span class="va">ids</span></span>
<span></span>
<span><span class="co">#Check that  it gives same results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ids_wave1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5702 3127 3267 3369 5449 3227</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids_wave1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 250</span></span></code></pre></div>
<p>We can use these sample ids to sample the Phase 2, Wave 1 data from
MatWgt_Sim, which holds the (hypothetically unknown)
<code>mat_weight_true</code> variable:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># We can use these ids to get the data:</span></span>
<span><span class="fu">set_mw</span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, slot <span class="op">=</span> <span class="st">"sampled_data"</span><span class="op">)</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">MatWgt_Sim</span><span class="op">[</span><span class="va">MatWgt_Sim</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_wave1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"mat_weight_true"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Then, we can use the function <code><a href="../reference/merge_samples.html">merge_samples()</a></code> to merge
the sampled data (250 rows of data sampled in wave 1 of phase 2) that we
just collected into our full dataframe (10,335 rows of data sampled in
phase 1). This function generates the dataframe for the
<code>"data"</code> slot of the specified wave using the
<code>"sampled data"</code> and the data from the previous wave (Phase 1
data in this case).</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MySurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">1</span>, fun <span class="op">=</span> <span class="st">"merge_samples"</span><span class="op">)</span></span></code></pre></div>
<p>All the slots for this wave are now filled! We can check to make sure
everything that we have done so far looks good using
<code><a href="../reference/multiwave_diagram.html">multiwave_diagram()</a></code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/multiwave_diagram.html">multiwave_diagram</a></span><span class="op">(</span><span class="va">MySurvey</span><span class="op">)</span></span></code></pre></div>
<center>
<p><img src="../inst/images/Diagram2.png" style="width:55.0%"></p>
</center>
<p>It does! Now that we have sampled data which we can use to estimate
stratum standard deviations, we can use <code><a href="../reference/allocate_wave.html">allocate_wave()</a></code> to
allocate samples optimally for the next wave. When applied to a
multiwave object using <code><a href="../reference/apply_multiwave.html">apply_multiwave()</a></code>,
<code><a href="../reference/allocate_wave.html">allocate_wave()</a></code> will find the data from the previous wave
(now the previous wave is Wave 1 of Phase 2) and will look for other
function arguments for <code><a href="../reference/allocate_wave.html">allocate_wave()</a></code> in the metadata. The
output will be placed in the <code>"design"</code> slot of the specified
wave:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MySurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_multiwave.html">apply_multiwave</a></span><span class="op">(</span><span class="va">MySurvey</span>, </span>
<span>                                    phase <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                    wave <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                    fun <span class="op">=</span> <span class="st">"allocate_wave"</span>,</span>
<span>                                    nsample <span class="op">=</span> <span class="fl">250</span>,</span>
<span>                                    already_sampled <span class="op">=</span> <span class="st">"phase_sample_ind2"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/get_mw.html">get_mw</a></span><span class="op">(</span><span class="va">MySurvey</span>, phase <span class="op">=</span> <span class="fl">2</span>, wave <span class="op">=</span> <span class="fl">2</span>, slot <span class="op">=</span> <span class="st">"design"</span><span class="op">)</span></span>
<span><span class="co">#&gt;                        strata npop nsample_optimal nsample_actual nsample_prior</span></span>
<span><span class="co">#&gt; 1 Black.MWC_est_(15.06,38.46]  628              57             57            23</span></span>
<span><span class="co">#&gt; 2  Black.MWC_est_(9.75,15.06] 1154              34             34            17</span></span>
<span><span class="co">#&gt; 3 Black.MWC_est_[-30.21,9.75]  745              55             55            31</span></span>
<span><span class="co">#&gt; 4 Other.MWC_est_(15.06,30.94]  325              15             15             8</span></span>
<span><span class="co">#&gt; 5  Other.MWC_est_(9.75,15.06]  929              29             29            13</span></span>
<span><span class="co">#&gt; 6  Other.MWC_est_[-5.39,9.75]  456              18             18            11</span></span>
<span><span class="co">#&gt; 7 White.MWC_est_(15.06,51.69] 1631             104            104            57</span></span>
<span><span class="co">#&gt; 8  White.MWC_est_(9.75,15.06] 3084              97             97            45</span></span>
<span><span class="co">#&gt; 9 White.MWC_est_[-25.68,9.75] 1383              91             91            45</span></span>
<span><span class="co">#&gt;   n_to_sample   sd</span></span>
<span><span class="co">#&gt; 1          34 4.67</span></span>
<span><span class="co">#&gt; 2          17 1.52</span></span>
<span><span class="co">#&gt; 3          24 3.80</span></span>
<span><span class="co">#&gt; 4           7 2.37</span></span>
<span><span class="co">#&gt; 5          16 1.61</span></span>
<span><span class="co">#&gt; 6           7 2.06</span></span>
<span><span class="co">#&gt; 7          47 3.29</span></span>
<span><span class="co">#&gt; 8          52 1.61</span></span>
<span><span class="co">#&gt; 9          46 3.37</span></span></code></pre></div>
<p>Now the design for Wave 2 is specified. We can continue with similar
steps for future waves!</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>Through these examples, we see the many benefits that the creation of
a Multiwave object offers in <code>optimall</code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jasper Yang, Pamela Shaw.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
